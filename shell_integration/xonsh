# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.


class _iTerm2Xonsh:
    """iTerm2 integration with Xonsh shell."""

    def __init__(self):
        self.version = 1
        self.stdout = @.imp.sys.__stdout__

        self.add_iterm2_to_prompt()

        @.env.register('ITERM2_INTEGRATION_EVENTS', type='bool', default=True,
                       doc="Use `False` to disable iTerm2 integration events and have basic prompt integration. "
                           "Default `True`.")
        if @.env.get('ITERM2_INTEGRATION_EVENTS'):
            self.add_iterm2_to_events()

        self.set_state()
        self.set_version()

        $ITERM2_INTEGRATION = True

    @staticmethod
    def is_iterm2_interactive():
        return (
            'iTerm' in @.env.get('TERM_PROGRAM', '')
            and @.env.get('XONSH_INTERACTIVE', False)
            and @.env.get('TERM','') not in ['linux', 'dumb']
        )

    @staticmethod
    def is_iterm2_interactive():
        term = @.env.get('TERM', '')
        term_program = @.env.get('TERM_PROGRAM', '')
        interactive = @.env.get('XONSH_INTERACTIVE', False)

        if term in ('linux', 'dumb'):
            return False

        tmux_enabled = bool(@.env.get('ITERM_ENABLE_SHELL_INTEGRATION_WITH_TMUX'))
        if not tmux_enabled and term in ('screen', 'screen-256color', 'tmux-256color'):
            return False

        return 'iTerm' in term_program and interactive


    def _get_hostname(self):
        if (iterm2_hostname := @.env.get('iterm2_hostname', '')):
            return iterm2_hostname

        try:
            if (host := $(hostname -f 2> /dev/null)):
                return host
        except Exception:
            pass

        try:
            if (host := $(hostname 2> /dev/null)):
                return host
        except Exception:
            pass

        return @.env.get('HOSTNAME', '')

    def set_state(self):
        if (user := @.env.get('USER', '')) and (host := self._get_hostname()):
            self.set_var("RemoteHost", f"{user}@{host}")

        if (cwd := @.env.get("PWD", @.imp.os.getcwd())):
            self.set_var("CurrentDir", cwd)

    def set_var(self, name, value):
        self.write_osc(f"1337;{name}={value}")

    def set_vars(self, vars):
        vars_str = ';'.join([f"{k}={v}" for k,v in vars.items()])
        self.write_osc(f"1337;{vars_str}")

    def set_user_var(self, key, value):
        b64value = @.imp.base64.b64encode(value.encode("utf-8")).decode("ascii").replace("\n", "")
        self.set_var("SetUserVar", f"{key}={b64value}")

    def _write_begin_osc(self):
        self.stdout.write("\033]")

    def _write_end_osc(self):
        self.stdout.write("\007")
        self.stdout.flush()

    def write_cr(self):
        if @.env.get("TERM_PROGRAM",'') == "iTerm.app":
            self.stdout.write("\r")
            self.stdout.flush()

    def write_osc(self, msg, cr=False):
        self._write_begin_osc()
        self.stdout.write(f"{msg}")
        if cr:
            self.write_cr()
        self._write_end_osc()

    def set_version(self):
        self.set_vars({"ShellIntegrationVersion": str(self.version), "shell": "xonsh"})

    def write_prompt_start_osc(self):
        self.write_osc("133;A")
        return ""

    def write_prompt_end_osc(self):
        self.write_osc("133;B")
        return ""

    def write_preexec_osc(self):
        self.write_osc("133;C;", cr=True)

    def write_return_code_osc(self, return_code):
        self.write_osc(f"133;D;{return_code}")


    # Events

    def _event_pre_prompt(self, **kwargs):
        self.set_state()

    def _event_pre_command(self, **kwargs):
        self.write_preexec_osc()

    def _event_post_command(self, **kwargs):
        self.write_return_code_osc(kwargs.get('rtn', 0))

    def add_iterm2_to_events(self):

        @events.on_pre_prompt
        def _iterm2_on_preprompt(**kwargs):
            self._event_pre_prompt(**kwargs)

        @events.on_precommand
        def _iterm2_on_precommand(**kwargs):
            self._event_pre_command(**kwargs)

        @events.on_postcommand
        def _iterm2_on_postcommand(**kwargs):
            self._event_post_command(**kwargs)




    def add_iterm2_to_prompt(self):
        $PROMPT_FIELDS['iterm2_prompt_start'] = self.write_prompt_start_osc
        $PROMPT_FIELDS['iterm2_prompt_end'] = self.write_prompt_end_osc
        if 'iterm2_prompt_start' not in $PROMPT:
            $PROMPT = '{iterm2_prompt_start}' + $PROMPT + '{iterm2_prompt_end}'


if _iTerm2Xonsh.is_iterm2_interactive():
    __xonsh__.iterm2 = _iTerm2Xonsh()
#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -eq 0 ]; then
    ssh 2>&1 | sed -e 's/usage: ssh/usage: it2ssh/' >&2
    exit 1
fi

function print_osc() {
    if [[ $TERM == screen* ]]; then
        printf "\033Ptmux;\033\033]"
    else
        printf "\033]"
    fi
}

# More of the tmux workaround described above.
function print_st() {
    if [[ $TERM == screen* ]]; then
        printf "\a\033\\"
    else
        printf "\a"
    fi
}

mkdir -p ~/.ssh/controlmasters
CONTROL_PATH="$HOME/.ssh/controlmasters/%r@%h:%p"

if command -v base64 > /dev/null 2> /dev/null; then
    base64_encode() { command base64 | command tr -d \\n\\r; }
    base64_decode() { command base64 -d; }
elif command -v b64encode > /dev/null 2> /dev/null; then
    base64_encode() { command b64encode - | command sed '1d;$d' | command tr -d \\n\\r; }
    base64_decode() { command fold -w 76 | command b64decode -r; }
elif detect_python; then
    pybase64() { command "$python" -c "import sys, base64; getattr(sys.stdout, 'buffer', sys.stdout).write(base64.standard_b64$1(getattr(sys.stdin, 'buffer', sys.stdin).read()))"; }
    base64_encode() { pybase64 "encode"; }
    base64_decode() { pybase64 "decode"; }
elif detect_perl; then
    base64_encode() { command "$perl" -MMIME::Base64 -0777 -ne 'print encode_base64($_)'; }
    base64_decode() { command "$perl" -MMIME::Base64 -ne 'print decode_base64($_)'; }
else
    die "base64 executable not present on local host"
fi

conductor="IyEvdXNyL2Jpbi9lbnYgYmFzaAojIFVzYWdlOgojIGNvbmR1Y3Rvci5zaCB0b2tlbgoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgR2xvYmFsIHZhcmlhYmxlcwpsb2dpbl9zaGVsbD0iIgpzaGVsbF9uYW1lPSIiCnF1aXQ9MApweXRob25fZGV0ZWN0ZWQ9IjAiCnBlcmxfZGV0ZWN0ZWQ9IjAiCmV4ZWNfc2hlbGw9MApydW5fY21kPTAKcnVuX3B5dGhvbj0wCnN0dHlfc2V0dGluZ3M9JChjb21tYW5kIHN0dHkgLWcpCgojIFV0aWxpdGllcwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKY2xlYW51cCgpIHsKICBjb21tYW5kIHN0dHkgIiRzdHR5X3NldHRpbmdzIgp9CgpkaWUoKSB7CiAgICBsb2cgZGllICIkKiIKICAgIHByaW50ZiAiXDAzM1szMW0lc1wwMzNbbVxuXHIiICIkKiIgPiAvZGV2L3N0ZGVycgogICAgY2xlYW51cAogICAgZXhpdCAxCn0KCml0MnNzaF92ZXJib3NlPTEKCmxvZygpIHsKICAgIGlmIFtbICRpdDJzc2hfdmVyYm9zZSA9PSAwIF1dOyB0aGVuCiAgICAgICAgcmV0dXJuCiAgICBmaQogICAgcHJpbnRmICJbJCRdICVzOiAlc1xuIiAkKGRhdGUgKyVIOiVNOiVTKSAiJCoiID4+IC90bXAvaXQyc3NoLmxvZwp9CgojIFByaW50aW5nIGNvbnRyb2wgc2VxdWVuY2VzCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpwcmludF9kY3MoKSB7CiAgICBsb2NhbCB0b2tlbj0kMQogICAgbG9jYWwgdW5pcXVlaWQ9JDIKICAgIGxvY2FsIGJvb2xhcmdzPSQzCiAgICBsb2NhbCBzc2hhcmdzPSQ0CiAgICBsb2cgb3NjIHByaW50X2RjcyAkMSAkMiAkMyAkNAoKICAgIHByaW50ZiAiXDAzM1AyMDAwcCIKICAgIHByaW50ZiAiJXMgJXMgJXMgLSAlc1xuIiAiJHt0b2tlbn0iICIke3VuaXF1ZWlkfSIgIiR7Ym9vbGFyZ3N9IiAiJHtzc2hhcmdzfSIKfQoKIyBTdHJpbmcgcGFyc2luZwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZmlyc3Rfd29yZCgpIHsKICAgIGxvY2FsIGlucHV0PSIkMSIKICAgIHByaW50ZiAiJXMiICR7aW5wdXQlJSAqfQp9Cgpkcm9wX2ZpcnN0X3dvcmQoKSB7CiAgICBsb2NhbCBpbnB1dD0iJDEiCiAgICBsb2cgZHJvcCBmaXJzdCB3b3JkIGZyb206ICIkaW5wdXQiCiAgICBwcmludGYgIiVzIiAiJHtpbnB1dCMqIH0iCn0KCmlmIGNvbW1hbmQgLXYgYmFzZTY0ID4gL2Rldi9udWxsIDI+IC9kZXYvbnVsbDsgdGhlbgogICAgbG9nICJmb3VuZCBiYXNlNjQgY29tbWFuZCIKICAgIGJhc2U2NF9lbmNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IHwgY29tbWFuZCB0ciAtZCBcXG5cXHI7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IC1kOyB9CmVsaWYgY29tbWFuZCAtdiBiNjRlbmNvZGUgPiAvZGV2L251bGwgMj4gL2Rldi9udWxsOyB0aGVuCiAgICBsb2cgImZvdW5kIGI2NGVuY29kZSwgYjY0ZGVjb2RlIGNvbW1hbmRzIgogICAgYmFzZTY0X2VuY29kZSgpIHsgY29tbWFuZCBiNjRlbmNvZGUgLSB8IGNvbW1hbmQgc2VkICcxZDskZCcgfCBjb21tYW5kIHRyIC1kIFxcblxccjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgY29tbWFuZCBmb2xkIC13IDc2IHwgY29tbWFuZCBiNjRkZWNvZGUgLXI7IH0KZWxpZiBkZXRlY3RfcHl0aG9uOyB0aGVuCiAgICBsb2cgInVzaW5nIHB5dGhvbiBmb3IgYmFzZTY0IgogICAgcHliYXNlNjQoKSB7IGNvbW1hbmQgIiRweXRob24iIC1jICJpbXBvcnQgc3lzLCBiYXNlNjQ7IGdldGF0dHIoc3lzLnN0ZG91dCwgJ2J1ZmZlcicsIHN5cy5zdGRvdXQpLndyaXRlKGJhc2U2NC5zdGFuZGFyZF9iNjQkMShnZXRhdHRyKHN5cy5zdGRpbiwgJ2J1ZmZlcicsIHN5cy5zdGRpbikucmVhZCgpKSkiOyB9CiAgICBiYXNlNjRfZW5jb2RlKCkgeyBweWJhc2U2NCAiZW5jb2RlIjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgcHliYXNlNjQgImRlY29kZSI7IH0KZWxpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgbG9nICJ1c2luZyBwZXJsIGZvciBiYXNlNjQiCiAgICBiYXNlNjRfZW5jb2RlKCkgeyBjb21tYW5kICIkcGVybCIgLU1NSU1FOjpCYXNlNjQgLTA3NzcgLW5lICdwcmludCBlbmNvZGVfYmFzZTY0KCRfKSc7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgIiRwZXJsIiAtTU1JTUU6OkJhc2U2NCAtbmUgJ3ByaW50IGRlY29kZV9iYXNlNjQoJF8pJzsgfQplbHNlCiAgICBkaWUgImJhc2U2NCBleGVjdXRhYmxlIG5vdCBwcmVzZW50IG9uIHJlbW90ZSBob3N0IgpmaQoKIyBHZXQgdXNlcidzIGxvZ2luIHNoZWxsCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpwYXJzZV9wYXNzd2RfcmVjb3JkKCkgewogICAgcHJpbnRmICIlcyIgIiQoY29tbWFuZCBncmVwIC1vICdbXjpdKiQnKSIKfQoKIyBzZXRzICRsb2dpbl9zaGVsbCBhcyBhIHNpZGUgZWZmZWN0LgojIHJldHVybnMgaWYgaXQgbG9va3MgZXhlY3V0YWJsZS4KbG9naW5fc2hlbGxfaXNfb2soKSB7CiAgICBsb2cgbG9naW5fc2hlbGxfaXNfb2sKICAgIFsgLW4gIiQxIiBdICYmIGxvZ2luX3NoZWxsPSQoZWNobyAkMSB8IHBhcnNlX3Bhc3N3ZF9yZWNvcmQpCiAgICBbIC1uICIkbG9naW5fc2hlbGwiIC1hIC14ICIkbG9naW5fc2hlbGwiIF0gJiYgcmV0dXJuIDAKICAgIGxvZyAibG9naW4gc2hlbGwgb2YgJGxvZ2luX3NoZWxsIGlzIG9rIgogICAgcmV0dXJuIDEKfQoKdXNpbmdfZ2V0ZW50KCkgewogICAgY21kPSQoY29tbWFuZCAtdiBnZXRlbnQpICYmIFsgLW4gIiRjbWQiIF0gJiYgb3V0cHV0PSQoY29tbWFuZCAiJGNtZCIgcGFzc3dkICIkVVNFUiIgMj4vZGV2L251bGwpIFwKICAgICYmIGxvZ2luX3NoZWxsX2lzX29rICIkb3V0cHV0Igp9Cgp1c2luZ19pZCgpIHsKICAgIGNtZD0kKGNvbW1hbmQgLXYgaWQpICYmIFsgLW4gIiRjbWQiIF0gJiYgb3V0cHV0PSQoY29tbWFuZCAiJGNtZCIgLVAgIiRVU0VSIiAyPi9kZXYvbnVsbCkgXAogICAgJiYgbG9naW5fc2hlbGxfaXNfb2sgIiRvdXRwdXQiCn0KCmRldGVjdF9weXRob24oKSB7CiAgICBpZiBbIHB5dGhvbl9kZXRlY3RlZCA9ICIxIiBdOyB0aGVuCiAgICAgICAgWyAtbiAiJHB5dGhvbiIgXSAmJiByZXR1cm4gMAogICAgICAgIHJldHVybiAxCiAgICBmaQogICAgcHl0aG9uX2RldGVjdGVkPSIxIgogICAgcHl0aG9uPSQoY29tbWFuZCAtdiBweXRob24zKQogICAgWyAteiAiJHB5dGhvbiIgXSAmJiBweXRob249JChjb21tYW5kIC12IHB5dGhvbjIpCiAgICBbIC16ICIkcHl0aG9uIiBdICYmIHB5dGhvbj0kKGNvbW1hbmQgLXYgcHl0aG9uKQogICAgaWYgWyAteiAiJHB5dGhvbiIgLW8gISAteCAiJHB5dGhvbiIgXTsgdGhlbiBweXRob249IiI7IHJldHVybiAxOyBmaQogICAgbG9nIG5vIHB5dGhvbgogICAgcmV0dXJuIDAKfQoKdXNpbmdfcHl0aG9uKCkgewogICAgZGV0ZWN0X3B5dGhvbiAmJiBvdXRwdXQ9JChjb21tYW5kICIkcHl0aG9uIiAtYyAiaW1wb3J0IHB3ZCwgb3M7IHByaW50KHB3ZC5nZXRwd3VpZChvcy5nZXRldWlkKCkpLnB3X3NoZWxsKSIpIFwKICAgICYmIGxvZ2luX3NoZWxsPSIkb3V0cHV0IiAmJiBsb2dpbl9zaGVsbF9pc19vawp9CgpkZXRlY3RfcGVybCgpIHsKICAgIGlmIFsgcGVybF9kZXRlY3RlZCA9ICIxIiBdOyB0aGVuCiAgICAgICAgWyAtbiAiJHBlcmwiIF0gJiYgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIHBlcmxfZGV0ZWN0ZWQ9IjEiCiAgICBwZXJsPSQoY29tbWFuZCAtdiBwZXJsKQogICAgaWYgWyAteiAiJHBlcmwiIC1vICEgLXggIiRwZXJsIiBdOyB0aGVuIHBlcmw9IiI7IHJldHVybiAxOyBmaQogICAgbG9nIG5vIHBlcmwKICAgIHJldHVybiAwCn0KCnVzaW5nX3BlcmwoKSB7CiAgICBkZXRlY3RfcGVybCAmJiBvdXRwdXQ9JChjb21tYW5kICIkcGVybCIgLWUgJ215ICRzaGVsbCA9IChnZXRwd3VpZCgkPCkpWzhdOyBwcmludCAkc2hlbGwnKSBcCiAgICAmJiBsb2dpbl9zaGVsbD0iJG91dHB1dCIgJiYgbG9naW5fc2hlbGxfaXNfb2sKfQoKdXNpbmdfc2hlbGxfZW52KCkgewogICAgWyAtbiAiJFNIRUxMIiBdICYmIGxvZ2luX3NoZWxsPSIkU0hFTEwiICYmIGxvZ2luX3NoZWxsX2lzX29rCn0KCmd1ZXNzX2xvZ2luX3NoZWxsKCkgewogICAgWyAtbiAiJGxvZ2luX3NoZWxsIiBdIHx8IHVzaW5nX2dldGVudCB8fCB1c2luZ19pZCB8fCB1c2luZ19weXRob24gfHwgdXNpbmdfcGVybCB8fCB1c2luZ19wYXNzd2QgfHwgdXNpbmdfc2hlbGxfZW52IHx8IGxvZ2luX3NoZWxsPSJzaCIKICAgIHNoZWxsX25hbWU9JChjb21tYW5kIGJhc2VuYW1lICRsb2dpbl9zaGVsbCkKICAgIGxvZyBsb2dpbiBzaGVsbCBpcyAke3NoZWxsX25hbWV9CiAgICBwcmludGYgIiVzIiAke3NoZWxsX25hbWV9Cn0KCiMgRXhlY3V0ZSBsb2dpbiBzaGVsbAojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZXhlY3V0ZV93aXRoX3BlcmwoKSB7CiAgICBpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgICAgIGxvZyBleGVjdXRlIGxvZ2luIHNoZWxsIHVzaW5nIHBlcmwKICAgICAgICBleGVjICIkcGVybCIgIi1lIiAiZXhlYyB7JyRsb2dpbl9zaGVsbCd9ICctJHNoZWxsX25hbWUnIgogICAgZmkKICAgIHJldHVybiAxCn0KCmV4ZWN1dGVfd2l0aF9weXRob24oKSB7CiAgICBpZiBkZXRlY3RfcHl0aG9uOyB0aGVuCiAgICAgICAgbG9nIGV4ZWN1dGUgbG9naW4gc2hlbGwgdXNpbmcgcHl0aG9uCiAgICAgICAgZXhlYyAiJHBlcmwiICItZSIgImV4ZWMgeyckbG9naW5fc2hlbGwnfSAnLSRzaGVsbF9uYW1lJyIKICAgICAgICBleGVjICIkcHl0aG9uIiAiLWMiICJpbXBvcnQgb3M7IG9zLmV4ZWNscCgnJGxvZ2luX3NoZWxsJywgJy0nICckc2hlbGxfbmFtZScpIgogICAgZmkKICAgIHJldHVybiAxCn0KCmV4ZWNfbG9naW5fc2hlbGwoKSB7CiAgICBsb2NhbCBsb2dpbl9zaGVsbD0kezF9CgogICAgbG9nIGV4ZWNfbG9naW5fc2hlbGwgIiRsb2dpbl9zaGVsbCIKCiAgICAjIFdlIG5lZWQgdG8gcGFzcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gdGhlIGV4ZWN1dGVkIHByb2dyYW0gd2l0aCBhIGxlYWRpbmcgLQogICAgIyB0byBtYWtlIHN1cmUgdGhlIHNoZWxsIGV4ZWN1dGVzIGFzIGEgbG9naW4gc2hlbGwuIE5vdGUgdGhhdCBub3QgYWxsIHNoZWxscwogICAgIyBzdXBwb3J0IGV4ZWMgLWEgc28gd2UgdXNlIHRoZSBiZWxvdyB0byB0cnkgdG8gZGV0ZWN0IHN1Y2ggc2hlbGxzCiAgICBbICIkKGV4ZWMgLWEgZWNobyBlY2hvIE9LIDI+IC9kZXYvbnVsbCkiID0gIk9LIiBdICYmIGV4ZWMgLWEgIi0kc2hlbGxfbmFtZSIgIiRsb2dpbl9zaGVsbCIKICAgIGxvZyBmYWlsZWQsIHRyeSBweXRob24KICAgIGV4ZWN1dGVfd2l0aF9weXRob24KICAgIGxvZyBmYWlsZWQsIHRyeSBwZXJsCiAgICBleGVjdXRlX3dpdGhfcGVybAogICAgbG9nIGZhaWxlZCwganVzdCBydW4gaXQgd2l0aCAtbAogICAgIyBUT0RPIC0gdGhpcyBpcyBjb21wbGljYXRlZCwgY29tZSBiYWNrIGFuZCBkbyBpdCBsYXRlci4KICAgICNleGVjdXRlX3NoX3dpdGhfcG9zaXhfZW52CiAgICBleGVjICIkbG9naW5fc2hlbGwiICItbCIKICAgIGxvZyBmYWlsZWQgY29tcGxldGVseQogICAgcHJpbnRmICIlc1xuIiAiQ291bGQgbm90IGV4ZWN1dGUgdGhlIHNoZWxsICRsb2dpbl9zaGVsbCBhcyBhIGxvZ2luIHNoZWxsIiA+IC9kZXYvc3RkZXJyCiAgICBleGVjICIkbG9naW5fc2hlbGwiCn0KCiMgQ29tbWFuZHMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCiMgRmlndXJlIG91dCB0aGUgdXNlcidzIGxvZ2luIHNoZWxsIGFuZCBydW4gaXQuCmNvbmR1Y3Rvcl9jbWRfZXhlY19sb2dpbl9zaGVsbCgpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX2V4ZWNfbG9naW5fc2hlbGwKICAgIGV4ZWNfc2hlbGw9MQp9CgpyZWFsbHlfZXhlY19sb2dpbl9zaGVsbCgpIHsKICAgIGV4ZWNfbG9naW5fc2hlbGwgJChndWVzc19sb2dpbl9zaGVsbCkKfQoKY29uZHVjdG9yX2NtZF9nZXRfc2hlbGwoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9nZXRfc2hlbGwKICAgIGVjaG8gJChndWVzc19sb2dpbl9zaGVsbCkKfQoKIyBTZXQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUuCmNvbmR1Y3Rvcl9jbWRfc2V0ZW52KCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfc2V0ZW52CiAgICBsb2NhbCBuYW1lPSQxCiAgICBsb2NhbCB2YWx1ZT0kMgoKICAgIGxvZyBzZXRlbnYgJHtuYW1lfT0ke3ZhbHVlfQogICAgZXhwb3J0ICR7bmFtZX09JHt2YWx1ZX0KfQoKY29uZHVjdG9yX2NtZF9ydW4oKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9ydW4KICAgIHJ1bl9jbWQ9MQp9Cgpjb25kdWN0b3JfY21kX3J1bnB5dGhvbigpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX3J1bnB5dGhvbgogICAgcnVuX3B5dGhvbj0xCn0KCnJlYWxseV9ydW5fcHl0aG9uKCkgewogIHJjZT0nCmltcG9ydCBvcwppbXBvcnQgc3lzCnR0eV9wYXRoID0gb3MudHR5bmFtZShzeXMuc3Rkb3V0LmZpbGVubygpKQpzeXMuc3RkaW4gPSBvcGVuKHR0eV9wYXRoLCAiciIpCnRyeToKICBwcmludChvcy5nZXRwaWQoKSkKICBwcmludCgiZW5kICciJGJvdW5kYXJ5IicgciAwIikKICBwcm9ncmFtPSIiCiAgZm9yIGxpbmUgaW4gc3lzLnN0ZGluOgogICAgaWYgbGluZS5yc3RyaXAoKSA9PSAiRU9GIjoKICAgICAgZXhlYyhwcm9ncmFtKQogICAgICBicmVhawogICAgcHJvZ3JhbSArPSBsaW5lCiAgcHJpbnQoInVuZXhwZWN0ZWQgRU9GIG9uIHN0ZGluIikKZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogIHByaW50KGUpCicKICBleGVjIHB5dGhvbjMgPDw8ICIkcmNlIgogIGV4aXQgMAp9CgpyZWFsbHlfcnVuKCkgewogICAgbG9nIGV4ZWMgIiRTSEVMTCIgLWMgIiQqIgogICAgZXhlYyAiJFNIRUxMIiAtYyAiJCoiCn0KCmNvbmR1Y3Rvcl9jbWRfc2hlbGwoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9zaGVsbAogICAgJCoKfQoKIyBVbnRhciBhIGJhc2U2NC1lbmNvZGVkIGZpbGUgYXQgYSBzcGVjaWZpZWQgbG9jYXRpb24uCmNvbmR1Y3Rvcl9jbWRfd3JpdGUoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF93cml0ZQogICAgbG9nIGhhdmUgJCMgYXJndW1lbnRzCiAgICBsb2cgd2lsbCB3cml0ZSB0byAiJDIiCgogICAgbG9jYWwgYjY0ZGF0YT0kMQogICAgIyBVc2UgZXZhbCB0byBleHBhbmQgJEhPTUUKICAgIGxvY2FsIGRlc3RpbmF0aW9uPSQoZXZhbCBwcmludGYgJXMgIiQyIikKCiAgICBsb2cgd3JpdGluZyB0byAkZGVzdGluYXRpb24gYmFzZWQgb24gJDIKCiAgICAjIGV4dHJhY3QgdGhlIHRhciBmaWxlIGF0b21pY2FsbHksIGluIHRoZSBzZW5zZSB0aGF0IGFueSBmaWxlIGZyb20gdGhlCiAgICAjIHRhcmZpbGUgaXMgb25seSBwdXQgaW50byBwbGFjZSBhZnRlciBpdCBoYXMgYmVlbiBmdWxseSB3cml0dGVuIHRvIGRpc2sKICAgICMgc3VwcHJlc3MgU1RERVJSIGZvciB0YXIgYXMgdGFyIHByaW50cyB2YXJpb3VzIHdhcm5pbmdzIGlmIGZvciBpbnN0YW5jZSwgdGltZXN0YW1wcyBhcmUgaW4gdGhlIGZ1dHVyZQogICAgb2xkX3VtYXNrPSQodW1hc2spCiAgICB1bWFzayAwMDAKICAgIHByaW50ZiAiJXMiICR7YjY0ZGF0YX0gfCBiYXNlNjRfZGVjb2RlIHwgY29tbWFuZCB0YXIgInhwemYiICItIiAiLUMiICIkZGVzdGluYXRpb24iCiAgICBsb2NhbCByYz0kPwogICAgdW1hc2sgIiRvbGRfdW1hc2siCiAgICAoZXhpdCAkcmMpCn0KCmNvbmR1Y3Rvcl9jbWRfY2QoKSB7CiAgICBsb2NhbCBkaXI9JDEKCiAgICBsb2cgY2QgJGRpcgogICAgY2QgIiRkaXIiID4gL2Rldi9udWxsIDI+JjEKfQoKY29uZHVjdG9yX2NtZF9xdWl0KCkgewogICAgbG9nIHF1aXQKICAgIHF1aXQ9MQp9Cgpjb25kdWN0b3JfY21kX3BzKCkgewogICAgY29tbWFuZCBwcyAtZW8gcGlkLHBwaWQsY29tbWFuZCB8IGNhdAp9Cgpjb25kdWN0b3JfY21kX2dldHBpZCgpIHsKICAgIGVjaG8gJCQKfQoKIyBNYWluIExvb3AKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmhhbmRsZV9jb21tYW5kKCkgewogICAgbG9jYWwgdW5wYXJzZWQ9JHsxfQoKICAgIGxvZyBoYW5kbGVfY29tbWFuZCAkdW5wYXJzZWQKCiAgICBsb2NhbCBjbWRfbmFtZT0kKGZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBjbWRfbmFtZSBpcyAkY21kX25hbWUKICAgIGxvY2FsIGFyZ3M9JChkcm9wX2ZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBhcmdzIGlzICRhcmdzCgogICAgbG9jYWwgYm91bmRhcnk9IiR7UkFORE9NfSR7UkFORE9NfSR7UkFORE9NfSR7UkFORE9NfSIKICAgIGVjaG8gYmVnaW4gJGJvdW5kYXJ5CiAgICBsb2cgaW52b2tlICRjbWRfbmFtZSB3aXRoIGFyZ3VtZW50cyAkYXJncwogICAgc2V0ICtlCiAgICBzZXQgK28gcGlwZWZhaWwKICAgIGlmIFtbICQodHlwZSAtdCBjb25kdWN0b3JfY21kXyR7Y21kX25hbWV9KSA9PSBmdW5jdGlvbiBdXTsgdGhlbgogICAgICAgIGNvbmR1Y3Rvcl9jbWRfJHtjbWRfbmFtZX0gJGFyZ3MKICAgIGVsc2UKICAgICAgICBlY2hvICJiYWQgY29tbWFuZCAke2NtZF9uYW1lfSIKICAgICAgICBmYWxzZQogICAgZmkKICAgIGlmIFtbICRydW5fcHl0aG9uID09IDEgXV07IHRoZW4KICAgICAgICByZWFsbHlfcnVuX3B5dGhvbiAiJGJvdW5kYXJ5IgogICAgZmkKICAgIGVjaG8gZW5kICRib3VuZGFyeSAkPyByCiAgICBpZiBbWyAkcXVpdCA9PSAxIF1dOyB0aGVuCiAgICAgICAgZXhpdCAwCiAgICBmaQogICAgaWYgW1sgJGV4ZWNfc2hlbGwgPT0gMSBdXTsgdGhlbgogICAgICAgIGVjaG8gdW5ob29rCiAgICAgICAgY2xlYW51cAogICAgICAgIHJlYWxseV9leGVjX2xvZ2luX3NoZWxsCiAgICBmaQogICAgaWYgW1sgJHJ1bl9jbWQgPT0gMSBdXTsgdGhlbgogICAgICAgIGVjaG8gdW5ob29rCiAgICAgICAgY2xlYW51cAogICAgICAgIHJlYWxseV9ydW4gJGFyZ3MKICAgIGZpCgogICAgc2V0IC1lCiAgICBzZXQgLW8gcGlwZWZhaWwKfQoKaXRlcmF0ZSgpIHsKICAgIGxvZyBpdGVyYXRlCgogICAgbGluZT0iIgogICAgd2hpbGUgdHJ1ZTsgZG8KICAgICAgICByZWFkIHBhcnQKICAgICAgICBsb2cgcmVhZCBwYXJ0ICIkcGFydCIKICAgICAgICBpZiBbIC16ICIkcGFydCIgXTsgdGhlbgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICAgICAgbGluZT0iJHtsaW5lfSR7cGFydH0iCiAgICBkb25lCgogICAgbG9nIHJlYWQgbGluZSAiJGxpbmUiCiAgICBoYW5kbGVfY29tbWFuZCAiJGxpbmUiCn0KCmRyYWluX3N0ZGluKCkgewogIGxvZyBkcmFpbl9zdGRpbgogIHN0dHkgLWVjaG8gLWljYW5vbiB0aW1lIDAgbWluIDAKICB3aGlsZSA6CiAgZG8KICAgICAga2V5PSIkKHByaW50ZiB4OyBkZCBicz0xIGNvdW50PTEgMj4gL2Rldi9udWxsOyBwcmludGYgeCkiCiAgICAgIGlmIFtbICIka2V5IiA9PSAieHgiIF1dOyB0aGVuCiAgICAgICAgICBsb2cgImRvbmUgZHJhaW5pbmciCiAgICAgICAgICBicmVhawogICAgICBmaQogICAgICBsb2cgIiRrZXkiCiAgZG9uZQogIGNsZWFudXAKfQoKbWFpbigpIHsKICAgIGxvY2FsIHRva2VuPSIkMSIKICAgIGxvY2FsIHVuaXF1ZWlkPSIkMiIKICAgIGxvY2FsIGJvb2xlYW5hcmdzPSIkMyIKICAgIGxvY2FsIHNzaGFyZ3M9IiQ0IgoKICAgIGxvZyBzdGFydGluZyB3aXRoIHRva2VuICR0b2tlbgogICAgbG9nICQoZW52KQoKICAgIHRyYXAgImNsZWFudXAiIEVYSVQKICAgIGRyYWluX3N0ZGluCiAgICBzdHR5IC1lY2hvCiAgICBwcmludF9kY3MgIiR0b2tlbiIgIiR1bmlxdWVpZCIgIiRib29sZWFuYXJncyIgIiRzc2hhcmdzIgoKICAgIGxvZyBiZWdpbiBtYWlubG9vcAoKICAgIHdoaWxlIHRydWU7IGRvCiAgICAgICAgaXRlcmF0ZQogICAgZG9uZQp9Cgo="

# Trying to escape this broke me.
eval_cmd=$(printf %s "J2V2YWwgIiQoZWNobyAiJDAiIHwgdHIgXFxcdlxcXGZcXFxyXFxcYiBcXFwwNDdcXFwxMzRcXFxuXFxcMDQxKSInIA==" | base64_decode)

sanitized="$(printf %s "$conductor" | base64_decode | tr "\!'\n\\" \\b\\v\\r\\f)"

SSH=/usr/bin/ssh
if [[ "$OSTYPE" == "darwin"* ]]; then
  TOKEN=""
  for SOCKET in ~/.config/iterm2/sockets/secrets ~/.iterm2/sockets/secrets ~/.iterm2-1/sockets/secrets
  do
      [ -z "$TOKEN" ] && TOKEN=$(nc -U $SOCKET || true)
  done
else
  TOKEN="none"
fi


if [ ! -d ~/.ssh ]; then
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

print_osc
printf "1337;Env=report=all:"
command env | base64_encode
print_st

SSHARGS=$(printf %s "$*" | base64_encode)
UNIQUEID=${RANDOM}${RANDOM}

USER_ARGS=()
HOSTNAME=""
COMMAND=()
ARGS_ALLOWED=1
EXPECT_VALUE=0
BOOLEAN_ARGS=$(ssh 2>&1 | tr -d '\n' | sed -e 's/^[^[]*\[-*\([a-z0-9A-Z]*\).*/\1/' || true)
HAS_T=0

while [[ $# -gt 0 ]]; do
    if [[ $EXPECT_VALUE == 1 ]]; then
        USER_ARGS+=("$1")
        EXPECT_VALUE=0
    elif [[ $ARGS_ALLOWED == 0 ]]; then
        if [[ $HOSTNAME == "" ]]; then
            HOSTNAME="$1"
        else
            COMMAND+=("$1")
        fi
    else
        case $1 in
            -N|-n|-f|-G)
                echo "it2sh is meant for interactive use via SSH only and is not compatible with the $1 argument."
                exit 1
                ;;
            -t)
                HAS_T=1
                USER_ARGS+=("-t")
                ;;
            -*)
                LETTER="${1:1}"
                if (printf %s "$BOOLEAN_ARGS" | grep "$LETTER"  > /dev/null 2>&1)
                then
                    EXPECT_VALUE=0
                else
                    EXPECT_VALUE=1
                fi
                USER_ARGS+=("$1")
                ;;
            --)
                ARGS_ALLOWED=0
                ;;
            *)
                ARGS_ALLOWED=0
                HOSTNAME="$1"
                ;;
        esac
    fi
    shift
done

if [[ $HAS_T == 0 ]]; then
    USER_ARGS+=("-t")
fi

# Here we do /usr/bin/env sh rather than exec sh to avoid adding this command
# to the login shell's history.
ENCODED_BA=$(printf %s "$BOOLEAN_ARGS" | base64_encode)

# If ssh gets a signal, let it2ssh keep running.
set +e

$SSH \
"${USER_ARGS[@]}" \
-- \
"$HOSTNAME" \
exec \
sh \
-c \
"$eval_cmd" \
\'"$sanitized main $TOKEN ${UNIQUEID} $ENCODED_BA $SSHARGS"\'

print_osc
printf "1337;EndSSH=%s" "${UNIQUEID}"
print_st


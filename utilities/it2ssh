#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -ne 1 ]; then
    echo "usage: it2ssh hostname" 1>&2
    exit 1
fi

mkdir -p ~/.ssh/controlmasters
CONTROL_PATH="$HOME/.ssh/controlmasters/%r@%h:%p"

if command -v base64 > /dev/null 2> /dev/null; then
    base64_decode() { command base64 -d; }
elif command -v b64encode > /dev/null 2> /dev/null; then
    base64_decode() { command fold -w 76 | command b64decode -r; }
elif detect_python; then
    pybase64() { command "$python" -c "import sys, base64; getattr(sys.stdout, 'buffer', sys.stdout).write(base64.standard_b64$1(getattr(sys.stdin, 'buffer', sys.stdin).read()))"; }
    base64_decode() { pybase64 "decode"; }
elif detect_perl; then
    base64_decode() { command "$perl" -MMIME::Base64 -ne 'print decode_base64($_)'; }
else
    die "base64 executable not present on remote host"
fi
# cat conductor.sh | base64
conductor='IyEvdXNyL2Jpbi9lbnYgYmFzaAojIFVzYWdlOgojIGNvbmR1Y3Rvci5zaCB0b2tlbgoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgR2xvYmFsIHZhcmlhYmxlcwpsb2dpbl9zaGVsbD0iIgpzaGVsbF9uYW1lPSIiCnF1aXQ9MApweXRob25fZGV0ZWN0ZWQ9IjAiCnBlcmxfZGV0ZWN0ZWQ9IjAiCgojIFV0aWxpdGllcwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKY2xlYW51cCgpIHsKICAgIGxvZyBjbGVhbnVwCiAgICBjb21tYW5kIHN0dHkgImVjaG8iIDI+IC9kZXYvbnVsbCA8IC9kZXYvdHR5Cn0KCmRpZSgpIHsKICAgIGxvZyBkaWUgIiQqIgogICAgcHJpbnRmICJcMDMzWzMxbSVzXDAzM1ttXG5cciIgIiQqIiA+IC9kZXYvc3RkZXJyCiAgICBjbGVhbnVwCiAgICBleGl0IDEKfQoKaXQyc3NoX3ZlcmJvc2U9MAoKbG9nKCkgewogICAgaWYgW1sgJGl0MnNzaF92ZXJib3NlID09IDAgXV07IHRoZW4KICAgICAgICByZXR1cm4KICAgIGZpCiAgICBwcmludGYgIlskJF0gJXM6ICVzXG4iICQoZGF0ZSArJUg6JU06JVMpICIkKiIgPj4gL3RtcC9pdDJzc2gubG9nCn0KCiMgUHJpbnRpbmcgY29udHJvbCBzZXF1ZW5jZXMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCnByaW50X29zYygpIHsKICAgIGlmIFtbICRURVJNID09IHNjcmVlbiogXV07IHRoZW4KICAgICAgICBwcmludGYgIlwwMzNQdG11eDtcMDMzXDAzM10iCiAgICBlbHNlCiAgICAgICAgcHJpbnRmICJcMDMzXSIKICAgIGZpCn0KCnByaW50X3N0KCkgewogICAgaWYgW1sgJFRFUk0gPT0gc2NyZWVuKiBdXTsgdGhlbgogICAgICAgIHByaW50ZiAiXGFcMDMzXFwiCiAgICBlbHNlCiAgICAgICAgcHJpbnRmICJcYSIKICAgIGZpCn0KCnByaW50XzEzMzcoKSB7CiAgICBsb2cgb3NjIDEzMzcgJDEKCiAgICBwcmludF9vc2MKICAgIHByaW50ZiAiMTMzNzslcyIgIiQxIgogICAgcHJpbnRfc3QKfQoKIyBTdHJpbmcgcGFyc2luZwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZmlyc3Rfd29yZCgpIHsKICAgIGxvY2FsIGlucHV0PSIkMSIKICAgIHByaW50ZiAiJXMiICR7aW5wdXQlJSAqfQp9Cgpkcm9wX2ZpcnN0X3dvcmQoKSB7CiAgICBsb2NhbCBpbnB1dD0iJDEiCiAgICBsb2cgZHJvcCBmaXJzdCB3b3JkIGZyb206ICIkaW5wdXQiCiAgICBwcmludGYgIiVzIiAiJHtpbnB1dCMqIH0iCn0KCmlmIGNvbW1hbmQgLXYgYmFzZTY0ID4gL2Rldi9udWxsIDI+IC9kZXYvbnVsbDsgdGhlbgogICAgbG9nICJmb3VuZCBiYXNlNjQgY29tbWFuZCIKICAgIGJhc2U2NF9lbmNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IHwgY29tbWFuZCB0ciAtZCBcXG5cXHI7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgYmFzZTY0IC1kOyB9CmVsaWYgY29tbWFuZCAtdiBiNjRlbmNvZGUgPiAvZGV2L251bGwgMj4gL2Rldi9udWxsOyB0aGVuCiAgICBsb2cgImZvdW5kIGI2NGVuY29kZSwgYjY0ZGVjb2RlIGNvbW1hbmRzIgogICAgYmFzZTY0X2VuY29kZSgpIHsgY29tbWFuZCBiNjRlbmNvZGUgLSB8IGNvbW1hbmQgc2VkICcxZDskZCcgfCBjb21tYW5kIHRyIC1kIFxcblxccjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgY29tbWFuZCBmb2xkIC13IDc2IHwgY29tbWFuZCBiNjRkZWNvZGUgLXI7IH0KZWxpZiBkZXRlY3RfcHl0aG9uOyB0aGVuCiAgICBsb2cgInVzaW5nIHB5dGhvbiBmb3IgYmFzZTY0IgogICAgcHliYXNlNjQoKSB7IGNvbW1hbmQgIiRweXRob24iIC1jICJpbXBvcnQgc3lzLCBiYXNlNjQ7IGdldGF0dHIoc3lzLnN0ZG91dCwgJ2J1ZmZlcicsIHN5cy5zdGRvdXQpLndyaXRlKGJhc2U2NC5zdGFuZGFyZF9iNjQkMShnZXRhdHRyKHN5cy5zdGRpbiwgJ2J1ZmZlcicsIHN5cy5zdGRpbikucmVhZCgpKSkiOyB9CiAgICBiYXNlNjRfZW5jb2RlKCkgeyBweWJhc2U2NCAiZW5jb2RlIjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgcHliYXNlNjQgImRlY29kZSI7IH0KZWxpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgbG9nICJ1c2luZyBwZXJsIGZvciBiYXNlNjQiCiAgICBiYXNlNjRfZW5jb2RlKCkgeyBjb21tYW5kICIkcGVybCIgLU1NSU1FOjpCYXNlNjQgLTA3NzcgLW5lICdwcmludCBlbmNvZGVfYmFzZTY0KCRfKSc7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgIiRwZXJsIiAtTU1JTUU6OkJhc2U2NCAtbmUgJ3ByaW50IGRlY29kZV9iYXNlNjQoJF8pJzsgfQplbHNlCiAgICBkaWUgImJhc2U2NCBleGVjdXRhYmxlIG5vdCBwcmVzZW50IG9uIHJlbW90ZSBob3N0IgpmaQoKIyBHZXQgdXNlcidzIGxvZ2luIHNoZWxsCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpwYXJzZV9wYXNzd2RfcmVjb3JkKCkgewogICAgcHJpbnRmICIlcyIgIiQoY29tbWFuZCBncmVwIC1vICdbXjpdKiQnKSIKfQoKIyBzZXRzICRsb2dpbl9zaGVsbCBhcyBhIHNpZGUgZWZmZWN0LgojIHJldHVybnMgaWYgaXQgbG9va3MgZXhlY3V0YWJsZS4KbG9naW5fc2hlbGxfaXNfb2soKSB7CiAgICBsb2cgbG9naW5fc2hlbGxfaXNfb2sKICAgIFsgLW4gIiQxIiBdICYmIGxvZ2luX3NoZWxsPSQoZWNobyAkMSB8IHBhcnNlX3Bhc3N3ZF9yZWNvcmQpCiAgICBbIC1uICIkbG9naW5fc2hlbGwiIC1hIC14ICIkbG9naW5fc2hlbGwiIF0gJiYgcmV0dXJuIDAKICAgIGxvZyAibG9naW4gc2hlbGwgb2YgJGxvZ2luX3NoZWxsIGlzIG9rIgogICAgcmV0dXJuIDEKfQoKdXNpbmdfZ2V0ZW50KCkgewogICAgY21kPSQoY29tbWFuZCAtdiBnZXRlbnQpICYmIFsgLW4gIiRjbWQiIF0gJiYgb3V0cHV0PSQoY29tbWFuZCAiJGNtZCIgcGFzc3dkICIkVVNFUiIgMj4vZGV2L251bGwpIFwKICAgICYmIGxvZ2luX3NoZWxsX2lzX29rICIkb3V0cHV0Igp9Cgp1c2luZ19pZCgpIHsKICAgIGNtZD0kKGNvbW1hbmQgLXYgaWQpICYmIFsgLW4gIiRjbWQiIF0gJiYgb3V0cHV0PSQoY29tbWFuZCAiJGNtZCIgLVAgIiRVU0VSIiAyPi9kZXYvbnVsbCkgXAogICAgJiYgbG9naW5fc2hlbGxfaXNfb2sgIiRvdXRwdXQiCn0KCmRldGVjdF9weXRob24oKSB7CiAgICBpZiBbIHB5dGhvbl9kZXRlY3RlZCA9ICIxIiBdOyB0aGVuCiAgICAgICAgWyAtbiAiJHB5dGhvbiIgXSAmJiByZXR1cm4gMAogICAgICAgIHJldHVybiAxCiAgICBmaQogICAgcHl0aG9uX2RldGVjdGVkPSIxIgogICAgcHl0aG9uPSQoY29tbWFuZCAtdiBweXRob24zKQogICAgWyAteiAiJHB5dGhvbiIgXSAmJiBweXRob249JChjb21tYW5kIC12IHB5dGhvbjIpCiAgICBbIC16ICIkcHl0aG9uIiBdICYmIHB5dGhvbj0kKGNvbW1hbmQgLXYgcHl0aG9uKQogICAgaWYgWyAteiAiJHB5dGhvbiIgLW8gISAteCAiJHB5dGhvbiIgXTsgdGhlbiBweXRob249IiI7IHJldHVybiAxOyBmaQogICAgbG9nIG5vIHB5dGhvbgogICAgcmV0dXJuIDAKfQoKdXNpbmdfcHl0aG9uKCkgewogICAgZGV0ZWN0X3B5dGhvbiAmJiBvdXRwdXQ9JChjb21tYW5kICIkcHl0aG9uIiAtYyAiaW1wb3J0IHB3ZCwgb3M7IHByaW50KHB3ZC5nZXRwd3VpZChvcy5nZXRldWlkKCkpLnB3X3NoZWxsKSIpIFwKICAgICYmIGxvZ2luX3NoZWxsPSIkb3V0cHV0IiAmJiBsb2dpbl9zaGVsbF9pc19vawp9CgpkZXRlY3RfcGVybCgpIHsKICAgIGlmIFsgcGVybF9kZXRlY3RlZCA9ICIxIiBdOyB0aGVuCiAgICAgICAgWyAtbiAiJHBlcmwiIF0gJiYgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIHBlcmxfZGV0ZWN0ZWQ9IjEiCiAgICBwZXJsPSQoY29tbWFuZCAtdiBwZXJsKQogICAgaWYgWyAteiAiJHBlcmwiIC1vICEgLXggIiRwZXJsIiBdOyB0aGVuIHBlcmw9IiI7IHJldHVybiAxOyBmaQogICAgbG9nIG5vIHBlcmwKICAgIHJldHVybiAwCn0KCnVzaW5nX3BlcmwoKSB7CiAgICBkZXRlY3RfcGVybCAmJiBvdXRwdXQ9JChjb21tYW5kICIkcGVybCIgLWUgJ215ICRzaGVsbCA9IChnZXRwd3VpZCgkPCkpWzhdOyBwcmludCAkc2hlbGwnKSBcCiAgICAmJiBsb2dpbl9zaGVsbD0iJG91dHB1dCIgJiYgbG9naW5fc2hlbGxfaXNfb2sKfQoKdXNpbmdfc2hlbGxfZW52KCkgewogICAgWyAtbiAiJFNIRUxMIiBdICYmIGxvZ2luX3NoZWxsPSIkU0hFTEwiICYmIGxvZ2luX3NoZWxsX2lzX29rCn0KCmd1ZXNzX2xvZ2luX3NoZWxsKCkgewogICAgWyAtbiAiJGxvZ2luX3NoZWxsIiBdIHx8IHVzaW5nX2dldGVudCB8fCB1c2luZ19pZCB8fCB1c2luZ19weXRob24gfHwgdXNpbmdfcGVybCB8fCB1c2luZ19wYXNzd2QgfHwgdXNpbmdfc2hlbGxfZW52IHx8IGxvZ2luX3NoZWxsPSJzaCIKICAgIHNoZWxsX25hbWU9JChjb21tYW5kIGJhc2VuYW1lICRsb2dpbl9zaGVsbCkKICAgIGxvZyBsb2dpbiBzaGVsbCBpcyAke3NoZWxsX25hbWV9CiAgICBwcmludGYgIiVzIiAke3NoZWxsX25hbWV9Cn0KCiMgRXhlY3V0ZSBsb2dpbiBzaGVsbAojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKZXhlY3V0ZV93aXRoX3BlcmwoKSB7CiAgICBpZiBkZXRlY3RfcGVybDsgdGhlbgogICAgICAgIGxvZyBleGVjdXRlIGxvZ2luIHNoZWxsIHVzaW5nIHBlcmwKICAgICAgICBleGVjICIkcGVybCIgIi1lIiAiZXhlYyB7JyRsb2dpbl9zaGVsbCd9ICctJHNoZWxsX25hbWUnIgogICAgZmkKICAgIHJldHVybiAxCn0KCmV4ZWN1dGVfd2l0aF9weXRob24oKSB7CiAgICBpZiBkZXRlY3RfcHl0aG9uOyB0aGVuCiAgICAgICAgbG9nIGV4ZWN1dGUgbG9naW4gc2hlbGwgdXNpbmcgcHl0aG9uCiAgICAgICAgZXhlYyAiJHBlcmwiICItZSIgImV4ZWMgeyckbG9naW5fc2hlbGwnfSAnLSRzaGVsbF9uYW1lJyIKICAgICAgICBleGVjICIkcHl0aG9uIiAiLWMiICJpbXBvcnQgb3M7IG9zLmV4ZWNscCgnJGxvZ2luX3NoZWxsJywgJy0nICckc2hlbGxfbmFtZScpIgogICAgZmkKICAgIHJldHVybiAxCn0KCmV4ZWNfbG9naW5fc2hlbGwoKSB7CiAgICBsb2NhbCBsb2dpbl9zaGVsbD0kezF9CgogICAgbG9nIGV4ZWNfbG9naW5fc2hlbGwgIiRsb2dpbl9zaGVsbCIKCiAgICAjIFdlIG5lZWQgdG8gcGFzcyB0aGUgZmlyc3QgYXJndW1lbnQgdG8gdGhlIGV4ZWN1dGVkIHByb2dyYW0gd2l0aCBhIGxlYWRpbmcgLQogICAgIyB0byBtYWtlIHN1cmUgdGhlIHNoZWxsIGV4ZWN1dGVzIGFzIGEgbG9naW4gc2hlbGwuIE5vdGUgdGhhdCBub3QgYWxsIHNoZWxscwogICAgIyBzdXBwb3J0IGV4ZWMgLWEgc28gd2UgdXNlIHRoZSBiZWxvdyB0byB0cnkgdG8gZGV0ZWN0IHN1Y2ggc2hlbGxzCiAgICBbICIkKGV4ZWMgLWEgZWNobyBlY2hvIE9LIDI+IC9kZXYvbnVsbCkiID0gIk9LIiBdICYmIGV4ZWMgLWEgIi0kc2hlbGxfbmFtZSIgIiRsb2dpbl9zaGVsbCIKICAgIGxvZyBmYWlsZWQsIHRyeSBweXRob24KICAgIGV4ZWN1dGVfd2l0aF9weXRob24KICAgIGxvZyBmYWlsZWQsIHRyeSBwZXJsCiAgICBleGVjdXRlX3dpdGhfcGVybAogICAgbG9nIGZhaWxlZCwganVzdCBydW4gaXQgd2l0aCAtbAogICAgIyBUT0RPIC0gdGhpcyBpcyBjb21wbGljYXRlZCwgY29tZSBiYWNrIGFuZCBkbyBpdCBsYXRlci4KICAgICNleGVjdXRlX3NoX3dpdGhfcG9zaXhfZW52CiAgICBleGVjICIkbG9naW5fc2hlbGwiICItbCIKICAgIGxvZyBmYWlsZWQgY29tcGxldGVseQogICAgcHJpbnRmICIlc1xuIiAiQ291bGQgbm90IGV4ZWN1dGUgdGhlIHNoZWxsICRsb2dpbl9zaGVsbCBhcyBhIGxvZ2luIHNoZWxsIiA+IC9kZXYvc3RkZXJyCiAgICBleGVjICIkbG9naW5fc2hlbGwiCn0KCiMgQ29tbWFuZHMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCiMgRmlndXJlIG91dCB0aGUgdXNlcidzIGxvZ2luIHNoZWxsIGFuZCBydW4gaXQuCmNvbmR1Y3Rvcl9jbWRfZXhlY19sb2dpbl9zaGVsbCgpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX2V4ZWNfbG9naW5fc2hlbGwKICAgIGV4ZWNfbG9naW5fc2hlbGwgJChndWVzc19sb2dpbl9zaGVsbCkKfQoKY29uZHVjdG9yX2NtZF9nZXRfc2hlbGwoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9nZXRfc2hlbGwKICAgIGVjaG8gJChndWVzc19sb2dpbl9zaGVsbCkKfQoKIyBTZXQgYW4gZW52aXJvbm1lbnQgdmFyaWFibGUuCmNvbmR1Y3Rvcl9jbWRfc2V0ZW52KCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfc2V0ZW52CiAgICBsb2NhbCBuYW1lPSQxCiAgICBsb2NhbCB2YWx1ZT0kMgoKICAgIGxvZyBzZXRlbnYgJHtuYW1lfT0ke3ZhbHVlfQogICAgZXhwb3J0ICR7bmFtZX09JHt2YWx1ZX0KfQoKY29uZHVjdG9yX2NtZF9ydW4oKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9ydW4gJCoKICAgICQqCn0KCiMgVW50YXIgYSBiYXNlNjQtZW5jb2RlZCBmaWxlIGF0IGEgc3BlY2lmaWVkIGxvY2F0aW9uLgpjb25kdWN0b3JfY21kX3dyaXRlKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfd3JpdGUKCiAgICBsb2NhbCBiNjRkYXRhPSQxCiAgICAjIEV4cGFuZCB+IHRvIGhvbWUgZGlyCiAgICBsb2NhbCBkZXN0aW5hdGlvbj0kezIvI1x+LyRIT01FfQoKICAgIGxvZyB3cml0aW5nIHRvICRkZXN0aW5hdGlvbiBiYXNlZCBvbiAkMgoKICAgICMgZXh0cmFjdCB0aGUgdGFyIGZpbGUgYXRvbWljYWxseSwgaW4gdGhlIHNlbnNlIHRoYXQgYW55IGZpbGUgZnJvbSB0aGUKICAgICMgdGFyZmlsZSBpcyBvbmx5IHB1dCBpbnRvIHBsYWNlIGFmdGVyIGl0IGhhcyBiZWVuIGZ1bGx5IHdyaXR0ZW4gdG8gZGlzawogICAgIyBzdXBwcmVzcyBTVERFUlIgZm9yIHRhciBhcyB0YXIgcHJpbnRzIHZhcmlvdXMgd2FybmluZ3MgaWYgZm9yIGluc3RhbmNlLCB0aW1lc3RhbXBzIGFyZSBpbiB0aGUgZnV0dXJlCiAgICBvbGRfdW1hc2s9JCh1bWFzaykKICAgIHVtYXNrIDAwMAogICAgcHJpbnRmICIlcyIgJHtiNjRkYXRhfSB8IGJhc2U2NF9kZWNvZGUgfCBjb21tYW5kIHRhciAieHB6ZiIgIi0iICItQyIgIiRkZXN0aW5hdGlvbiIgMj4gL2Rldi9udWxsCiAgICB1bWFzayAiJG9sZF91bWFzayIKfQoKY29uZHVjdG9yX2NtZF9jZCgpIHsKICAgIGxvY2FsIGRpcj0kMQoKICAgIGxvZyBjZCAkZGlyCiAgICBjZCAiJGRpciIgPiAvZGV2L251bGwgMj4mMQp9Cgpjb25kdWN0b3JfY21kX3F1aXQoKSB7CiAgICBsb2cgcXVpdAogICAgcXVpdD0xCn0KCmNvbmR1Y3Rvcl9jbWRfcHMoKSB7CiAgICBjb21tYW5kIHBzIC1lbyBwaWQscHBpZCxjb21tYW5kIHwgY2F0Cn0KCmNvbmR1Y3Rvcl9jbWRfZ2V0cGlkKCkgewogICAgZWNobyAkJAp9CgojIE1haW4gTG9vcAojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKaGFuZGxlX2NvbW1hbmQoKSB7CiAgICBsb2NhbCB1bnBhcnNlZD0kezF9CgogICAgbG9nIGhhbmRsZV9jb21tYW5kICR1bnBhcnNlZAoKICAgIGxvY2FsIGNtZF9uYW1lPSQoZmlyc3Rfd29yZCAiJHt1bnBhcnNlZH0iKQogICAgbG9nIGNtZF9uYW1lIGlzICRjbWRfbmFtZQogICAgbG9jYWwgYXJncz0kKGRyb3BfZmlyc3Rfd29yZCAiJHt1bnBhcnNlZH0iKQogICAgbG9nIGFyZ3MgaXMgJGFyZ3MKCiAgICBsb2NhbCBib3VuZGFyeT0iJHtSQU5ET019JHtSQU5ET019JHtSQU5ET019JHtSQU5ET019IgogICAgZWNobyBiZWdpbiAkYm91bmRhcnkKICAgIGxvZyBpbnZva2UgJGNtZF9uYW1lIHdpdGggYXJndW1lbnRzICRhcmdzCiAgICBzZXQgK2UKICAgIGlmIFtbICQodHlwZSAtdCBjb25kdWN0b3JfY21kXyR7Y21kX25hbWV9KSA9PSBmdW5jdGlvbiBdXTsgdGhlbgogICAgICAgIGNvbmR1Y3Rvcl9jbWRfJHtjbWRfbmFtZX0gJGFyZ3MKICAgIGVsc2UKICAgICAgICBlY2hvICJiYWQgY29tbWFuZCAke2NtZF9uYW1lfSIKICAgICAgICBmYWxzZQogICAgZmkKICAgIGVjaG8gZW5kICQ/ICRib3VuZGFyeQogICAgaWYgW1sgJHF1aXQgPT0gMSBdXTsgdGhlbgogICAgICAgIGV4aXQgMAogICAgZmkKICAgIHNldCAtZQp9CgppdGVyYXRlKCkgewogICAgbG9nIGl0ZXJhdGUKCiAgICByZWFkIGxpbmUKICAgIGxvZyByZWFkIGxpbmUgIiRsaW5lIgogICAgaGFuZGxlX2NvbW1hbmQgIiRsaW5lIgp9CgptYWluKCkgewogICAgbG9jYWwgdG9rZW49JDEKCiAgICBsb2cgc3RhcnRpbmcgd2l0aCB0b2tlbiAkdG9rZW4KCiAgICBwcmludF8xMzM3ICJDb25kdWN0PXN0YXJ0O3Rva2VuPSQocHJpbnRmICIlcyIgIiR0b2tlbiIgfCBiYXNlNjRfZW5jb2RlKSIKCiAgICBsb2cgYmVnaW4gbWFpbmxvb3AKCiAgICB3aGlsZSB0cnVlOyBkbwogICAgICAgIGl0ZXJhdGUKICAgIGRvbmUKfQoK'

# Trying to escape this broke me.
eval_cmd=$(printf %s "J2V2YWwgIiQoZWNobyAiJDAiIHwgdHIgXFxcdlxcXGZcXFxyXFxcYiBcXFwwNDdcXFwxMzRcXFxuXFxcMDQxKSInIA==" | base64_decode)

sanitized="$(printf %s "$conductor" | base64_decode | tr "\!'\n\\" \\b\\v\\r\\f)"

SSH=/usr/bin/ssh
TOKEN=1234

if [ ! -d ~/.ssh ]; then
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

$SSH \
-t \
-o \
ControlMaster=auto \
-o \
ControlPath=~/.ssh/control-%h-%p-%r \
-o \
ControlPersist=yes \
-o \
ServerAliveInterval=60 \
-o \
ServerAliveCountMax=5 \
-o \
TCPKeepAlive=no \
-- \
$1 \
exec \
sh \
-c \
"$eval_cmd" \
\'"$sanitized main $TOKEN"\'


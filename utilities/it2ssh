#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -ne 1 ]; then
    echo "usage: it2ssh hostname" 1>&2
    exit 1
fi

mkdir -p ~/.ssh/controlmasters
CONTROL_PATH="$HOME/.ssh/controlmasters/%r@%h:%p"

if command -v base64 > /dev/null 2> /dev/null; then
    base64_encode() { command base64 | command tr -d \\n\\r; }
    base64_decode() { command base64 -d; }
elif command -v b64encode > /dev/null 2> /dev/null; then
    base64_encode() { command b64encode - | command sed '1d;$d' | command tr -d \\n\\r; }
    base64_decode() { command fold -w 76 | command b64decode -r; }
elif detect_python; then
    pybase64() { command "$python" -c "import sys, base64; getattr(sys.stdout, 'buffer', sys.stdout).write(base64.standard_b64$1(getattr(sys.stdin, 'buffer', sys.stdin).read()))"; }
    base64_encode() { pybase64 "encode"; }
    base64_decode() { pybase64 "decode"; }
elif detect_perl; then
    base64_encode() { command "$perl" -MMIME::Base64 -0777 -ne 'print encode_base64($_)'; }
    base64_decode() { command "$perl" -MMIME::Base64 -ne 'print decode_base64($_)'; }
else
    die "base64 executable not present on local host"
fi

conductor="IyEvdXNyL2Jpbi9lbnYgYmFzaAojIFVzYWdlOgojIGNvbmR1Y3Rvci5zaCB0b2tlbgoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgR2xvYmFsIHZhcmlhYmxlcwpsb2dpbl9zaGVsbD0iIgpzaGVsbF9uYW1lPSIiCnF1aXQ9MApweXRob25fZGV0ZWN0ZWQ9IjAiCnBlcmxfZGV0ZWN0ZWQ9IjAiCmV4ZWNfc2hlbGw9MApzdHR5X3NldHRpbmdzPSQoY29tbWFuZCBzdHR5IC1nKQoKIyBVdGlsaXRpZXMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmNsZWFudXAoKSB7CiAgY29tbWFuZCBzdHR5ICIkc3R0eV9zZXR0aW5ncyIKfQoKZGllKCkgewogICAgbG9nIGRpZSAiJCoiCiAgICBwcmludGYgIlwwMzNbMzFtJXNcMDMzW21cblxyIiAiJCoiID4gL2Rldi9zdGRlcnIKICAgIGNsZWFudXAKICAgIGV4aXQgMQp9CgppdDJzc2hfdmVyYm9zZT0wCgpsb2coKSB7CiAgICBpZiBbWyAkaXQyc3NoX3ZlcmJvc2UgPT0gMCBdXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKICAgIHByaW50ZiAiWyQkXSAlczogJXNcbiIgJChkYXRlICslSDolTTolUykgIiQqIiA+PiAvdG1wL2l0MnNzaC5sb2cKfQoKIyBQcmludGluZyBjb250cm9sIHNlcXVlbmNlcwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKcHJpbnRfZGNzKCkgewogICAgbG9jYWwgdG9rZW49JDEKICAgIGxvY2FsIHNzaGFyZ3M9JDIKICAgIGxvZyBvc2MgcHJpbnRfZGNzICQxICQyCgogICAgcHJpbnRmICJcMDMzUDIwMDBwIgogICAgcHJpbnRmICIlcyAlc1xuIiAiJHt0b2tlbn0iICIke3NzaGFyZ3N9Igp9CgojIFN0cmluZyBwYXJzaW5nCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpmaXJzdF93b3JkKCkgewogICAgbG9jYWwgaW5wdXQ9IiQxIgogICAgcHJpbnRmICIlcyIgJHtpbnB1dCUlICp9Cn0KCmRyb3BfZmlyc3Rfd29yZCgpIHsKICAgIGxvY2FsIGlucHV0PSIkMSIKICAgIGxvZyBkcm9wIGZpcnN0IHdvcmQgZnJvbTogIiRpbnB1dCIKICAgIHByaW50ZiAiJXMiICIke2lucHV0IyogfSIKfQoKaWYgY29tbWFuZCAtdiBiYXNlNjQgPiAvZGV2L251bGwgMj4gL2Rldi9udWxsOyB0aGVuCiAgICBsb2cgImZvdW5kIGJhc2U2NCBjb21tYW5kIgogICAgYmFzZTY0X2VuY29kZSgpIHsgY29tbWFuZCBiYXNlNjQgfCBjb21tYW5kIHRyIC1kIFxcblxccjsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgY29tbWFuZCBiYXNlNjQgLWQ7IH0KZWxpZiBjb21tYW5kIC12IGI2NGVuY29kZSA+IC9kZXYvbnVsbCAyPiAvZGV2L251bGw7IHRoZW4KICAgIGxvZyAiZm91bmQgYjY0ZW5jb2RlLCBiNjRkZWNvZGUgY29tbWFuZHMiCiAgICBiYXNlNjRfZW5jb2RlKCkgeyBjb21tYW5kIGI2NGVuY29kZSAtIHwgY29tbWFuZCBzZWQgJzFkOyRkJyB8IGNvbW1hbmQgdHIgLWQgXFxuXFxyOyB9CiAgICBiYXNlNjRfZGVjb2RlKCkgeyBjb21tYW5kIGZvbGQgLXcgNzYgfCBjb21tYW5kIGI2NGRlY29kZSAtcjsgfQplbGlmIGRldGVjdF9weXRob247IHRoZW4KICAgIGxvZyAidXNpbmcgcHl0aG9uIGZvciBiYXNlNjQiCiAgICBweWJhc2U2NCgpIHsgY29tbWFuZCAiJHB5dGhvbiIgLWMgImltcG9ydCBzeXMsIGJhc2U2NDsgZ2V0YXR0cihzeXMuc3Rkb3V0LCAnYnVmZmVyJywgc3lzLnN0ZG91dCkud3JpdGUoYmFzZTY0LnN0YW5kYXJkX2I2NCQxKGdldGF0dHIoc3lzLnN0ZGluLCAnYnVmZmVyJywgc3lzLnN0ZGluKS5yZWFkKCkpKSI7IH0KICAgIGJhc2U2NF9lbmNvZGUoKSB7IHB5YmFzZTY0ICJlbmNvZGUiOyB9CiAgICBiYXNlNjRfZGVjb2RlKCkgeyBweWJhc2U2NCAiZGVjb2RlIjsgfQplbGlmIGRldGVjdF9wZXJsOyB0aGVuCiAgICBsb2cgInVzaW5nIHBlcmwgZm9yIGJhc2U2NCIKICAgIGJhc2U2NF9lbmNvZGUoKSB7IGNvbW1hbmQgIiRwZXJsIiAtTU1JTUU6OkJhc2U2NCAtMDc3NyAtbmUgJ3ByaW50IGVuY29kZV9iYXNlNjQoJF8pJzsgfQogICAgYmFzZTY0X2RlY29kZSgpIHsgY29tbWFuZCAiJHBlcmwiIC1NTUlNRTo6QmFzZTY0IC1uZSAncHJpbnQgZGVjb2RlX2Jhc2U2NCgkXyknOyB9CmVsc2UKICAgIGRpZSAiYmFzZTY0IGV4ZWN1dGFibGUgbm90IHByZXNlbnQgb24gcmVtb3RlIGhvc3QiCmZpCgojIEdldCB1c2VyJ3MgbG9naW4gc2hlbGwKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCnBhcnNlX3Bhc3N3ZF9yZWNvcmQoKSB7CiAgICBwcmludGYgIiVzIiAiJChjb21tYW5kIGdyZXAgLW8gJ1teOl0qJCcpIgp9CgojIHNldHMgJGxvZ2luX3NoZWxsIGFzIGEgc2lkZSBlZmZlY3QuCiMgcmV0dXJucyBpZiBpdCBsb29rcyBleGVjdXRhYmxlLgpsb2dpbl9zaGVsbF9pc19vaygpIHsKICAgIGxvZyBsb2dpbl9zaGVsbF9pc19vawogICAgWyAtbiAiJDEiIF0gJiYgbG9naW5fc2hlbGw9JChlY2hvICQxIHwgcGFyc2VfcGFzc3dkX3JlY29yZCkKICAgIFsgLW4gIiRsb2dpbl9zaGVsbCIgLWEgLXggIiRsb2dpbl9zaGVsbCIgXSAmJiByZXR1cm4gMAogICAgbG9nICJsb2dpbiBzaGVsbCBvZiAkbG9naW5fc2hlbGwgaXMgb2siCiAgICByZXR1cm4gMQp9Cgp1c2luZ19nZXRlbnQoKSB7CiAgICBjbWQ9JChjb21tYW5kIC12IGdldGVudCkgJiYgWyAtbiAiJGNtZCIgXSAmJiBvdXRwdXQ9JChjb21tYW5kICIkY21kIiBwYXNzd2QgIiRVU0VSIiAyPi9kZXYvbnVsbCkgXAogICAgJiYgbG9naW5fc2hlbGxfaXNfb2sgIiRvdXRwdXQiCn0KCnVzaW5nX2lkKCkgewogICAgY21kPSQoY29tbWFuZCAtdiBpZCkgJiYgWyAtbiAiJGNtZCIgXSAmJiBvdXRwdXQ9JChjb21tYW5kICIkY21kIiAtUCAiJFVTRVIiIDI+L2Rldi9udWxsKSBcCiAgICAmJiBsb2dpbl9zaGVsbF9pc19vayAiJG91dHB1dCIKfQoKZGV0ZWN0X3B5dGhvbigpIHsKICAgIGlmIFsgcHl0aG9uX2RldGVjdGVkID0gIjEiIF07IHRoZW4KICAgICAgICBbIC1uICIkcHl0aG9uIiBdICYmIHJldHVybiAwCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCiAgICBweXRob25fZGV0ZWN0ZWQ9IjEiCiAgICBweXRob249JChjb21tYW5kIC12IHB5dGhvbjMpCiAgICBbIC16ICIkcHl0aG9uIiBdICYmIHB5dGhvbj0kKGNvbW1hbmQgLXYgcHl0aG9uMikKICAgIFsgLXogIiRweXRob24iIF0gJiYgcHl0aG9uPSQoY29tbWFuZCAtdiBweXRob24pCiAgICBpZiBbIC16ICIkcHl0aG9uIiAtbyAhIC14ICIkcHl0aG9uIiBdOyB0aGVuIHB5dGhvbj0iIjsgcmV0dXJuIDE7IGZpCiAgICBsb2cgbm8gcHl0aG9uCiAgICByZXR1cm4gMAp9Cgp1c2luZ19weXRob24oKSB7CiAgICBkZXRlY3RfcHl0aG9uICYmIG91dHB1dD0kKGNvbW1hbmQgIiRweXRob24iIC1jICJpbXBvcnQgcHdkLCBvczsgcHJpbnQocHdkLmdldHB3dWlkKG9zLmdldGV1aWQoKSkucHdfc2hlbGwpIikgXAogICAgJiYgbG9naW5fc2hlbGw9IiRvdXRwdXQiICYmIGxvZ2luX3NoZWxsX2lzX29rCn0KCmRldGVjdF9wZXJsKCkgewogICAgaWYgWyBwZXJsX2RldGVjdGVkID0gIjEiIF07IHRoZW4KICAgICAgICBbIC1uICIkcGVybCIgXSAmJiByZXR1cm4gMAogICAgICAgIHJldHVybiAxCiAgICBmaQogICAgcGVybF9kZXRlY3RlZD0iMSIKICAgIHBlcmw9JChjb21tYW5kIC12IHBlcmwpCiAgICBpZiBbIC16ICIkcGVybCIgLW8gISAteCAiJHBlcmwiIF07IHRoZW4gcGVybD0iIjsgcmV0dXJuIDE7IGZpCiAgICBsb2cgbm8gcGVybAogICAgcmV0dXJuIDAKfQoKdXNpbmdfcGVybCgpIHsKICAgIGRldGVjdF9wZXJsICYmIG91dHB1dD0kKGNvbW1hbmQgIiRwZXJsIiAtZSAnbXkgJHNoZWxsID0gKGdldHB3dWlkKCQ8KSlbOF07IHByaW50ICRzaGVsbCcpIFwKICAgICYmIGxvZ2luX3NoZWxsPSIkb3V0cHV0IiAmJiBsb2dpbl9zaGVsbF9pc19vawp9Cgp1c2luZ19zaGVsbF9lbnYoKSB7CiAgICBbIC1uICIkU0hFTEwiIF0gJiYgbG9naW5fc2hlbGw9IiRTSEVMTCIgJiYgbG9naW5fc2hlbGxfaXNfb2sKfQoKZ3Vlc3NfbG9naW5fc2hlbGwoKSB7CiAgICBbIC1uICIkbG9naW5fc2hlbGwiIF0gfHwgdXNpbmdfZ2V0ZW50IHx8IHVzaW5nX2lkIHx8IHVzaW5nX3B5dGhvbiB8fCB1c2luZ19wZXJsIHx8IHVzaW5nX3Bhc3N3ZCB8fCB1c2luZ19zaGVsbF9lbnYgfHwgbG9naW5fc2hlbGw9InNoIgogICAgc2hlbGxfbmFtZT0kKGNvbW1hbmQgYmFzZW5hbWUgJGxvZ2luX3NoZWxsKQogICAgbG9nIGxvZ2luIHNoZWxsIGlzICR7c2hlbGxfbmFtZX0KICAgIHByaW50ZiAiJXMiICR7c2hlbGxfbmFtZX0KfQoKIyBFeGVjdXRlIGxvZ2luIHNoZWxsCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpleGVjdXRlX3dpdGhfcGVybCgpIHsKICAgIGlmIGRldGVjdF9wZXJsOyB0aGVuCiAgICAgICAgbG9nIGV4ZWN1dGUgbG9naW4gc2hlbGwgdXNpbmcgcGVybAogICAgICAgIGV4ZWMgIiRwZXJsIiAiLWUiICJleGVjIHsnJGxvZ2luX3NoZWxsJ30gJy0kc2hlbGxfbmFtZSciCiAgICBmaQogICAgcmV0dXJuIDEKfQoKZXhlY3V0ZV93aXRoX3B5dGhvbigpIHsKICAgIGlmIGRldGVjdF9weXRob247IHRoZW4KICAgICAgICBsb2cgZXhlY3V0ZSBsb2dpbiBzaGVsbCB1c2luZyBweXRob24KICAgICAgICBleGVjICIkcGVybCIgIi1lIiAiZXhlYyB7JyRsb2dpbl9zaGVsbCd9ICctJHNoZWxsX25hbWUnIgogICAgICAgIGV4ZWMgIiRweXRob24iICItYyIgImltcG9ydCBvczsgb3MuZXhlY2xwKCckbG9naW5fc2hlbGwnLCAnLScgJyRzaGVsbF9uYW1lJykiCiAgICBmaQogICAgcmV0dXJuIDEKfQoKZXhlY19sb2dpbl9zaGVsbCgpIHsKICAgIGxvY2FsIGxvZ2luX3NoZWxsPSR7MX0KCiAgICBsb2cgZXhlY19sb2dpbl9zaGVsbCAiJGxvZ2luX3NoZWxsIgoKICAgICMgV2UgbmVlZCB0byBwYXNzIHRoZSBmaXJzdCBhcmd1bWVudCB0byB0aGUgZXhlY3V0ZWQgcHJvZ3JhbSB3aXRoIGEgbGVhZGluZyAtCiAgICAjIHRvIG1ha2Ugc3VyZSB0aGUgc2hlbGwgZXhlY3V0ZXMgYXMgYSBsb2dpbiBzaGVsbC4gTm90ZSB0aGF0IG5vdCBhbGwgc2hlbGxzCiAgICAjIHN1cHBvcnQgZXhlYyAtYSBzbyB3ZSB1c2UgdGhlIGJlbG93IHRvIHRyeSB0byBkZXRlY3Qgc3VjaCBzaGVsbHMKICAgIFsgIiQoZXhlYyAtYSBlY2hvIGVjaG8gT0sgMj4gL2Rldi9udWxsKSIgPSAiT0siIF0gJiYgZXhlYyAtYSAiLSRzaGVsbF9uYW1lIiAiJGxvZ2luX3NoZWxsIgogICAgbG9nIGZhaWxlZCwgdHJ5IHB5dGhvbgogICAgZXhlY3V0ZV93aXRoX3B5dGhvbgogICAgbG9nIGZhaWxlZCwgdHJ5IHBlcmwKICAgIGV4ZWN1dGVfd2l0aF9wZXJsCiAgICBsb2cgZmFpbGVkLCBqdXN0IHJ1biBpdCB3aXRoIC1sCiAgICAjIFRPRE8gLSB0aGlzIGlzIGNvbXBsaWNhdGVkLCBjb21lIGJhY2sgYW5kIGRvIGl0IGxhdGVyLgogICAgI2V4ZWN1dGVfc2hfd2l0aF9wb3NpeF9lbnYKICAgIGV4ZWMgIiRsb2dpbl9zaGVsbCIgIi1sIgogICAgbG9nIGZhaWxlZCBjb21wbGV0ZWx5CiAgICBwcmludGYgIiVzXG4iICJDb3VsZCBub3QgZXhlY3V0ZSB0aGUgc2hlbGwgJGxvZ2luX3NoZWxsIGFzIGEgbG9naW4gc2hlbGwiID4gL2Rldi9zdGRlcnIKICAgIGV4ZWMgIiRsb2dpbl9zaGVsbCIKfQoKIyBDb21tYW5kcwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKIyBGaWd1cmUgb3V0IHRoZSB1c2VyJ3MgbG9naW4gc2hlbGwgYW5kIHJ1biBpdC4KY29uZHVjdG9yX2NtZF9leGVjX2xvZ2luX3NoZWxsKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfZXhlY19sb2dpbl9zaGVsbAogICAgZXhlY19zaGVsbD0xCn0KCnJlYWxseV9leGVjX2xvZ2luX3NoZWxsKCkgewogICAgZXhlY19sb2dpbl9zaGVsbCAkKGd1ZXNzX2xvZ2luX3NoZWxsKQp9Cgpjb25kdWN0b3JfY21kX2dldF9zaGVsbCgpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX2dldF9zaGVsbAogICAgZWNobyAkKGd1ZXNzX2xvZ2luX3NoZWxsKQp9CgojIFNldCBhbiBlbnZpcm9ubWVudCB2YXJpYWJsZS4KY29uZHVjdG9yX2NtZF9zZXRlbnYoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9zZXRlbnYKICAgIGxvY2FsIG5hbWU9JDEKICAgIGxvY2FsIHZhbHVlPSQyCgogICAgbG9nIHNldGVudiAke25hbWV9PSR7dmFsdWV9CiAgICBleHBvcnQgJHtuYW1lfT0ke3ZhbHVlfQp9Cgpjb25kdWN0b3JfY21kX3J1bigpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX3J1biAkKgogICAgJCoKfQoKIyBVbnRhciBhIGJhc2U2NC1lbmNvZGVkIGZpbGUgYXQgYSBzcGVjaWZpZWQgbG9jYXRpb24uCmNvbmR1Y3Rvcl9jbWRfd3JpdGUoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF93cml0ZQoKICAgIGxvY2FsIGI2NGRhdGE9JDEKICAgICMgRXhwYW5kIH4gdG8gaG9tZSBkaXIKICAgIGxvY2FsIGRlc3RpbmF0aW9uPSR7Mi8jXH4vJEhPTUV9CgogICAgbG9nIHdyaXRpbmcgdG8gJGRlc3RpbmF0aW9uIGJhc2VkIG9uICQyCgogICAgIyBleHRyYWN0IHRoZSB0YXIgZmlsZSBhdG9taWNhbGx5LCBpbiB0aGUgc2Vuc2UgdGhhdCBhbnkgZmlsZSBmcm9tIHRoZQogICAgIyB0YXJmaWxlIGlzIG9ubHkgcHV0IGludG8gcGxhY2UgYWZ0ZXIgaXQgaGFzIGJlZW4gZnVsbHkgd3JpdHRlbiB0byBkaXNrCiAgICAjIHN1cHByZXNzIFNUREVSUiBmb3IgdGFyIGFzIHRhciBwcmludHMgdmFyaW91cyB3YXJuaW5ncyBpZiBmb3IgaW5zdGFuY2UsIHRpbWVzdGFtcHMgYXJlIGluIHRoZSBmdXR1cmUKICAgIG9sZF91bWFzaz0kKHVtYXNrKQogICAgdW1hc2sgMDAwCiAgICBwcmludGYgIiVzIiAke2I2NGRhdGF9IHwgYmFzZTY0X2RlY29kZSB8IGNvbW1hbmQgdGFyICJ4cHpmIiAiLSIgIi1DIiAiJGRlc3RpbmF0aW9uIiAyPiAvZGV2L251bGwKICAgIHVtYXNrICIkb2xkX3VtYXNrIgp9Cgpjb25kdWN0b3JfY21kX2NkKCkgewogICAgbG9jYWwgZGlyPSQxCgogICAgbG9nIGNkICRkaXIKICAgIGNkICIkZGlyIiA+IC9kZXYvbnVsbCAyPiYxCn0KCmNvbmR1Y3Rvcl9jbWRfcXVpdCgpIHsKICAgIGxvZyBxdWl0CiAgICBxdWl0PTEKfQoKY29uZHVjdG9yX2NtZF9wcygpIHsKICAgIGNvbW1hbmQgcHMgLWVvIHBpZCxwcGlkLGNvbW1hbmQgfCBjYXQKfQoKY29uZHVjdG9yX2NtZF9nZXRwaWQoKSB7CiAgICBlY2hvICQkCn0KCiMgTWFpbiBMb29wCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgpoYW5kbGVfY29tbWFuZCgpIHsKICAgIGxvY2FsIHVucGFyc2VkPSR7MX0KCiAgICBsb2cgaGFuZGxlX2NvbW1hbmQgJHVucGFyc2VkCgogICAgbG9jYWwgY21kX25hbWU9JChmaXJzdF93b3JkICIke3VucGFyc2VkfSIpCiAgICBsb2cgY21kX25hbWUgaXMgJGNtZF9uYW1lCiAgICBsb2NhbCBhcmdzPSQoZHJvcF9maXJzdF93b3JkICIke3VucGFyc2VkfSIpCiAgICBsb2cgYXJncyBpcyAkYXJncwoKICAgIGxvY2FsIGJvdW5kYXJ5PSIke1JBTkRPTX0ke1JBTkRPTX0ke1JBTkRPTX0ke1JBTkRPTX0iCiAgICBlY2hvIGJlZ2luICRib3VuZGFyeQogICAgbG9nIGludm9rZSAkY21kX25hbWUgd2l0aCBhcmd1bWVudHMgJGFyZ3MKICAgIHNldCArZQogICAgaWYgW1sgJCh0eXBlIC10IGNvbmR1Y3Rvcl9jbWRfJHtjbWRfbmFtZX0pID09IGZ1bmN0aW9uIF1dOyB0aGVuCiAgICAgICAgY29uZHVjdG9yX2NtZF8ke2NtZF9uYW1lfSAkYXJncwogICAgZWxzZQogICAgICAgIGVjaG8gImJhZCBjb21tYW5kICR7Y21kX25hbWV9IgogICAgICAgIGZhbHNlCiAgICBmaQogICAgZWNobyBlbmQgJGJvdW5kYXJ5ICQ/CiAgICBpZiBbWyAkcXVpdCA9PSAxIF1dOyB0aGVuCiAgICAgICAgZXhpdCAwCiAgICBmaQogICAgaWYgW1sgJGV4ZWNfc2hlbGwgPT0gMSBdXTsgdGhlbgogICAgICAgIGVjaG8gdW5ob29rCiAgICAgICAgY2xlYW51cAogICAgICAgIHJlYWxseV9leGVjX2xvZ2luX3NoZWxsCiAgICBmaQogICAgc2V0IC1lCn0KCml0ZXJhdGUoKSB7CiAgICBsb2cgaXRlcmF0ZQoKICAgIHJlYWQgbGluZQogICAgbG9nIHJlYWQgbGluZSAiJGxpbmUiCiAgICBoYW5kbGVfY29tbWFuZCAiJGxpbmUiCn0KCm1haW4oKSB7CiAgICBsb2NhbCB0b2tlbj0kMQogICAgbG9jYWwgc3NoYXJncz0kKHByaW50ZiAlcyAiJDIiIHwgYmFzZTY0X2RlY29kZSkKCiAgICBsb2cgc3RhcnRpbmcgd2l0aCB0b2tlbiAkdG9rZW4KCiAgICB0cmFwICJjbGVhbnVwIiBFWElUCiAgICBjb21tYW5kIHN0dHkgIi1lY2hvIiA8IC9kZXYvdHR5CiAgICBwcmludF9kY3MgIiR0b2tlbiIgIiRzc2hhcmdzIgoKICAgIGxvZyBiZWdpbiBtYWlubG9vcAoKICAgIHdoaWxlIHRydWU7IGRvCiAgICAgICAgaXRlcmF0ZQogICAgZG9uZQp9Cgo="

# Trying to escape this broke me.
eval_cmd=$(printf %s "J2V2YWwgIiQoZWNobyAiJDAiIHwgdHIgXFxcdlxcXGZcXFxyXFxcYiBcXFwwNDdcXFwxMzRcXFxuXFxcMDQxKSInIA==" | base64_decode)

sanitized="$(printf %s "$conductor" | base64_decode | tr "\!'\n\\" \\b\\v\\r\\f)"

SSH=/usr/bin/ssh
TOKEN="${ITERM_SESSION_ID#*:}"

if [ ! -d ~/.ssh ]; then
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

SSHARGS=$(printf %s "$*" | base64_encode)

$SSH \
-t \
-o \
ControlMaster=auto \
-o \
ControlPath=~/.ssh/control-%h-%p-%r \
-o \
ControlPersist=yes \
-o \
ServerAliveInterval=60 \
-o \
ServerAliveCountMax=5 \
-o \
TCPKeepAlive=no \
-- \
$1 \
exec \
sh \
-c \
"$eval_cmd" \
\'"$sanitized main $TOKEN $SSHARGS"\'


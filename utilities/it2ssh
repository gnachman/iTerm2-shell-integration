#!/usr/bin/env bash

set -euo pipefail

if [ "$#" -ne 1 ]; then
    echo "usage: it2ssh hostname" 1>&2
    exit 1
fi

function print_osc() {
    if [[ $TERM == screen* ]]; then
        printf "\033Ptmux;\033\033]"
    else
        printf "\033]"
    fi
}

# More of the tmux workaround described above.
function print_st() {
    if [[ $TERM == screen* ]]; then
        printf "\a\033\\"
    else
        printf "\a"
    fi
}

mkdir -p ~/.ssh/controlmasters
CONTROL_PATH="$HOME/.ssh/controlmasters/%r@%h:%p"

if command -v base64 > /dev/null 2> /dev/null; then
    base64_encode() { command base64 | command tr -d \\n\\r; }
    base64_decode() { command base64 -d; }
elif command -v b64encode > /dev/null 2> /dev/null; then
    base64_encode() { command b64encode - | command sed '1d;$d' | command tr -d \\n\\r; }
    base64_decode() { command fold -w 76 | command b64decode -r; }
elif detect_python; then
    pybase64() { command "$python" -c "import sys, base64; getattr(sys.stdout, 'buffer', sys.stdout).write(base64.standard_b64$1(getattr(sys.stdin, 'buffer', sys.stdin).read()))"; }
    base64_encode() { pybase64 "encode"; }
    base64_decode() { pybase64 "decode"; }
elif detect_perl; then
    base64_encode() { command "$perl" -MMIME::Base64 -0777 -ne 'print encode_base64($_)'; }
    base64_decode() { command "$perl" -MMIME::Base64 -ne 'print decode_base64($_)'; }
else
    die "base64 executable not present on local host"
fi

conductor="IyEvdXNyL2Jpbi9lbnYgYmFzaAojIFVzYWdlOgojIGNvbmR1Y3Rvci5zaCB0b2tlbgoKc2V0IC1ldW8gcGlwZWZhaWwKCiMgR2xvYmFsIHZhcmlhYmxlcwpsb2dpbl9zaGVsbD0iIgpzaGVsbF9uYW1lPSIiCnF1aXQ9MApweXRob25fZGV0ZWN0ZWQ9IjAiCnBlcmxfZGV0ZWN0ZWQ9IjAiCmV4ZWNfc2hlbGw9MApzdHR5X3NldHRpbmdzPSQoY29tbWFuZCBzdHR5IC1nKQoKIyBVdGlsaXRpZXMKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmNsZWFudXAoKSB7CiAgY29tbWFuZCBzdHR5ICIkc3R0eV9zZXR0aW5ncyIKfQoKZGllKCkgewogICAgbG9nIGRpZSAiJCoiCiAgICBwcmludGYgIlwwMzNbMzFtJXNcMDMzW21cblxyIiAiJCoiID4gL2Rldi9zdGRlcnIKICAgIGNsZWFudXAKICAgIGV4aXQgMQp9CgppdDJzc2hfdmVyYm9zZT0wCgpsb2coKSB7CiAgICBpZiBbWyAkaXQyc3NoX3ZlcmJvc2UgPT0gMCBdXTsgdGhlbgogICAgICAgIHJldHVybgogICAgZmkKICAgIHByaW50ZiAiWyQkXSAlczogJXNcbiIgJChkYXRlICslSDolTTolUykgIiQqIiA+PiAvdG1wL2l0MnNzaC5sb2cKfQoKIyBQcmludGluZyBjb250cm9sIHNlcXVlbmNlcwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKcHJpbnRfZGNzKCkgewogICAgbG9jYWwgdG9rZW49JDEKICAgIGxvY2FsIHVuaXF1ZWlkPSQyCiAgICBsb2NhbCBzc2hhcmdzPSQzCiAgICBsb2cgb3NjIHByaW50X2RjcyAkMSAkMiAkMwoKICAgIHByaW50ZiAiXDAzM1AyMDAwcCIKICAgIHByaW50ZiAiJXMgJXMgLSAlc1xuIiAiJHt0b2tlbn0iICIke3VuaXF1ZWlkfSIgIiR7c3NoYXJnc30iCn0KCiMgU3RyaW5nIHBhcnNpbmcKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmZpcnN0X3dvcmQoKSB7CiAgICBsb2NhbCBpbnB1dD0iJDEiCiAgICBwcmludGYgIiVzIiAke2lucHV0JSUgKn0KfQoKZHJvcF9maXJzdF93b3JkKCkgewogICAgbG9jYWwgaW5wdXQ9IiQxIgogICAgbG9nIGRyb3AgZmlyc3Qgd29yZCBmcm9tOiAiJGlucHV0IgogICAgcHJpbnRmICIlcyIgIiR7aW5wdXQjKiB9Igp9CgppZiBjb21tYW5kIC12IGJhc2U2NCA+IC9kZXYvbnVsbCAyPiAvZGV2L251bGw7IHRoZW4KICAgIGxvZyAiZm91bmQgYmFzZTY0IGNvbW1hbmQiCiAgICBiYXNlNjRfZW5jb2RlKCkgeyBjb21tYW5kIGJhc2U2NCB8IGNvbW1hbmQgdHIgLWQgXFxuXFxyOyB9CiAgICBiYXNlNjRfZGVjb2RlKCkgeyBjb21tYW5kIGJhc2U2NCAtZDsgfQplbGlmIGNvbW1hbmQgLXYgYjY0ZW5jb2RlID4gL2Rldi9udWxsIDI+IC9kZXYvbnVsbDsgdGhlbgogICAgbG9nICJmb3VuZCBiNjRlbmNvZGUsIGI2NGRlY29kZSBjb21tYW5kcyIKICAgIGJhc2U2NF9lbmNvZGUoKSB7IGNvbW1hbmQgYjY0ZW5jb2RlIC0gfCBjb21tYW5kIHNlZCAnMWQ7JGQnIHwgY29tbWFuZCB0ciAtZCBcXG5cXHI7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IGNvbW1hbmQgZm9sZCAtdyA3NiB8IGNvbW1hbmQgYjY0ZGVjb2RlIC1yOyB9CmVsaWYgZGV0ZWN0X3B5dGhvbjsgdGhlbgogICAgbG9nICJ1c2luZyBweXRob24gZm9yIGJhc2U2NCIKICAgIHB5YmFzZTY0KCkgeyBjb21tYW5kICIkcHl0aG9uIiAtYyAiaW1wb3J0IHN5cywgYmFzZTY0OyBnZXRhdHRyKHN5cy5zdGRvdXQsICdidWZmZXInLCBzeXMuc3Rkb3V0KS53cml0ZShiYXNlNjQuc3RhbmRhcmRfYjY0JDEoZ2V0YXR0cihzeXMuc3RkaW4sICdidWZmZXInLCBzeXMuc3RkaW4pLnJlYWQoKSkpIjsgfQogICAgYmFzZTY0X2VuY29kZSgpIHsgcHliYXNlNjQgImVuY29kZSI7IH0KICAgIGJhc2U2NF9kZWNvZGUoKSB7IHB5YmFzZTY0ICJkZWNvZGUiOyB9CmVsaWYgZGV0ZWN0X3Blcmw7IHRoZW4KICAgIGxvZyAidXNpbmcgcGVybCBmb3IgYmFzZTY0IgogICAgYmFzZTY0X2VuY29kZSgpIHsgY29tbWFuZCAiJHBlcmwiIC1NTUlNRTo6QmFzZTY0IC0wNzc3IC1uZSAncHJpbnQgZW5jb2RlX2Jhc2U2NCgkXyknOyB9CiAgICBiYXNlNjRfZGVjb2RlKCkgeyBjb21tYW5kICIkcGVybCIgLU1NSU1FOjpCYXNlNjQgLW5lICdwcmludCBkZWNvZGVfYmFzZTY0KCRfKSc7IH0KZWxzZQogICAgZGllICJiYXNlNjQgZXhlY3V0YWJsZSBub3QgcHJlc2VudCBvbiByZW1vdGUgaG9zdCIKZmkKCiMgR2V0IHVzZXIncyBsb2dpbiBzaGVsbAojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwoKcGFyc2VfcGFzc3dkX3JlY29yZCgpIHsKICAgIHByaW50ZiAiJXMiICIkKGNvbW1hbmQgZ3JlcCAtbyAnW146XSokJykiCn0KCiMgc2V0cyAkbG9naW5fc2hlbGwgYXMgYSBzaWRlIGVmZmVjdC4KIyByZXR1cm5zIGlmIGl0IGxvb2tzIGV4ZWN1dGFibGUuCmxvZ2luX3NoZWxsX2lzX29rKCkgewogICAgbG9nIGxvZ2luX3NoZWxsX2lzX29rCiAgICBbIC1uICIkMSIgXSAmJiBsb2dpbl9zaGVsbD0kKGVjaG8gJDEgfCBwYXJzZV9wYXNzd2RfcmVjb3JkKQogICAgWyAtbiAiJGxvZ2luX3NoZWxsIiAtYSAteCAiJGxvZ2luX3NoZWxsIiBdICYmIHJldHVybiAwCiAgICBsb2cgImxvZ2luIHNoZWxsIG9mICRsb2dpbl9zaGVsbCBpcyBvayIKICAgIHJldHVybiAxCn0KCnVzaW5nX2dldGVudCgpIHsKICAgIGNtZD0kKGNvbW1hbmQgLXYgZ2V0ZW50KSAmJiBbIC1uICIkY21kIiBdICYmIG91dHB1dD0kKGNvbW1hbmQgIiRjbWQiIHBhc3N3ZCAiJFVTRVIiIDI+L2Rldi9udWxsKSBcCiAgICAmJiBsb2dpbl9zaGVsbF9pc19vayAiJG91dHB1dCIKfQoKdXNpbmdfaWQoKSB7CiAgICBjbWQ9JChjb21tYW5kIC12IGlkKSAmJiBbIC1uICIkY21kIiBdICYmIG91dHB1dD0kKGNvbW1hbmQgIiRjbWQiIC1QICIkVVNFUiIgMj4vZGV2L251bGwpIFwKICAgICYmIGxvZ2luX3NoZWxsX2lzX29rICIkb3V0cHV0Igp9CgpkZXRlY3RfcHl0aG9uKCkgewogICAgaWYgWyBweXRob25fZGV0ZWN0ZWQgPSAiMSIgXTsgdGhlbgogICAgICAgIFsgLW4gIiRweXRob24iIF0gJiYgcmV0dXJuIDAKICAgICAgICByZXR1cm4gMQogICAgZmkKICAgIHB5dGhvbl9kZXRlY3RlZD0iMSIKICAgIHB5dGhvbj0kKGNvbW1hbmQgLXYgcHl0aG9uMykKICAgIFsgLXogIiRweXRob24iIF0gJiYgcHl0aG9uPSQoY29tbWFuZCAtdiBweXRob24yKQogICAgWyAteiAiJHB5dGhvbiIgXSAmJiBweXRob249JChjb21tYW5kIC12IHB5dGhvbikKICAgIGlmIFsgLXogIiRweXRob24iIC1vICEgLXggIiRweXRob24iIF07IHRoZW4gcHl0aG9uPSIiOyByZXR1cm4gMTsgZmkKICAgIGxvZyBubyBweXRob24KICAgIHJldHVybiAwCn0KCnVzaW5nX3B5dGhvbigpIHsKICAgIGRldGVjdF9weXRob24gJiYgb3V0cHV0PSQoY29tbWFuZCAiJHB5dGhvbiIgLWMgImltcG9ydCBwd2QsIG9zOyBwcmludChwd2QuZ2V0cHd1aWQob3MuZ2V0ZXVpZCgpKS5wd19zaGVsbCkiKSBcCiAgICAmJiBsb2dpbl9zaGVsbD0iJG91dHB1dCIgJiYgbG9naW5fc2hlbGxfaXNfb2sKfQoKZGV0ZWN0X3BlcmwoKSB7CiAgICBpZiBbIHBlcmxfZGV0ZWN0ZWQgPSAiMSIgXTsgdGhlbgogICAgICAgIFsgLW4gIiRwZXJsIiBdICYmIHJldHVybiAwCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCiAgICBwZXJsX2RldGVjdGVkPSIxIgogICAgcGVybD0kKGNvbW1hbmQgLXYgcGVybCkKICAgIGlmIFsgLXogIiRwZXJsIiAtbyAhIC14ICIkcGVybCIgXTsgdGhlbiBwZXJsPSIiOyByZXR1cm4gMTsgZmkKICAgIGxvZyBubyBwZXJsCiAgICByZXR1cm4gMAp9Cgp1c2luZ19wZXJsKCkgewogICAgZGV0ZWN0X3BlcmwgJiYgb3V0cHV0PSQoY29tbWFuZCAiJHBlcmwiIC1lICdteSAkc2hlbGwgPSAoZ2V0cHd1aWQoJDwpKVs4XTsgcHJpbnQgJHNoZWxsJykgXAogICAgJiYgbG9naW5fc2hlbGw9IiRvdXRwdXQiICYmIGxvZ2luX3NoZWxsX2lzX29rCn0KCnVzaW5nX3NoZWxsX2VudigpIHsKICAgIFsgLW4gIiRTSEVMTCIgXSAmJiBsb2dpbl9zaGVsbD0iJFNIRUxMIiAmJiBsb2dpbl9zaGVsbF9pc19vawp9CgpndWVzc19sb2dpbl9zaGVsbCgpIHsKICAgIFsgLW4gIiRsb2dpbl9zaGVsbCIgXSB8fCB1c2luZ19nZXRlbnQgfHwgdXNpbmdfaWQgfHwgdXNpbmdfcHl0aG9uIHx8IHVzaW5nX3BlcmwgfHwgdXNpbmdfcGFzc3dkIHx8IHVzaW5nX3NoZWxsX2VudiB8fCBsb2dpbl9zaGVsbD0ic2giCiAgICBzaGVsbF9uYW1lPSQoY29tbWFuZCBiYXNlbmFtZSAkbG9naW5fc2hlbGwpCiAgICBsb2cgbG9naW4gc2hlbGwgaXMgJHtzaGVsbF9uYW1lfQogICAgcHJpbnRmICIlcyIgJHtzaGVsbF9uYW1lfQp9CgojIEV4ZWN1dGUgbG9naW4gc2hlbGwKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmV4ZWN1dGVfd2l0aF9wZXJsKCkgewogICAgaWYgZGV0ZWN0X3Blcmw7IHRoZW4KICAgICAgICBsb2cgZXhlY3V0ZSBsb2dpbiBzaGVsbCB1c2luZyBwZXJsCiAgICAgICAgZXhlYyAiJHBlcmwiICItZSIgImV4ZWMgeyckbG9naW5fc2hlbGwnfSAnLSRzaGVsbF9uYW1lJyIKICAgIGZpCiAgICByZXR1cm4gMQp9CgpleGVjdXRlX3dpdGhfcHl0aG9uKCkgewogICAgaWYgZGV0ZWN0X3B5dGhvbjsgdGhlbgogICAgICAgIGxvZyBleGVjdXRlIGxvZ2luIHNoZWxsIHVzaW5nIHB5dGhvbgogICAgICAgIGV4ZWMgIiRwZXJsIiAiLWUiICJleGVjIHsnJGxvZ2luX3NoZWxsJ30gJy0kc2hlbGxfbmFtZSciCiAgICAgICAgZXhlYyAiJHB5dGhvbiIgIi1jIiAiaW1wb3J0IG9zOyBvcy5leGVjbHAoJyRsb2dpbl9zaGVsbCcsICctJyAnJHNoZWxsX25hbWUnKSIKICAgIGZpCiAgICByZXR1cm4gMQp9CgpleGVjX2xvZ2luX3NoZWxsKCkgewogICAgbG9jYWwgbG9naW5fc2hlbGw9JHsxfQoKICAgIGxvZyBleGVjX2xvZ2luX3NoZWxsICIkbG9naW5fc2hlbGwiCgogICAgIyBXZSBuZWVkIHRvIHBhc3MgdGhlIGZpcnN0IGFyZ3VtZW50IHRvIHRoZSBleGVjdXRlZCBwcm9ncmFtIHdpdGggYSBsZWFkaW5nIC0KICAgICMgdG8gbWFrZSBzdXJlIHRoZSBzaGVsbCBleGVjdXRlcyBhcyBhIGxvZ2luIHNoZWxsLiBOb3RlIHRoYXQgbm90IGFsbCBzaGVsbHMKICAgICMgc3VwcG9ydCBleGVjIC1hIHNvIHdlIHVzZSB0aGUgYmVsb3cgdG8gdHJ5IHRvIGRldGVjdCBzdWNoIHNoZWxscwogICAgWyAiJChleGVjIC1hIGVjaG8gZWNobyBPSyAyPiAvZGV2L251bGwpIiA9ICJPSyIgXSAmJiBleGVjIC1hICItJHNoZWxsX25hbWUiICIkbG9naW5fc2hlbGwiCiAgICBsb2cgZmFpbGVkLCB0cnkgcHl0aG9uCiAgICBleGVjdXRlX3dpdGhfcHl0aG9uCiAgICBsb2cgZmFpbGVkLCB0cnkgcGVybAogICAgZXhlY3V0ZV93aXRoX3BlcmwKICAgIGxvZyBmYWlsZWQsIGp1c3QgcnVuIGl0IHdpdGggLWwKICAgICMgVE9ETyAtIHRoaXMgaXMgY29tcGxpY2F0ZWQsIGNvbWUgYmFjayBhbmQgZG8gaXQgbGF0ZXIuCiAgICAjZXhlY3V0ZV9zaF93aXRoX3Bvc2l4X2VudgogICAgZXhlYyAiJGxvZ2luX3NoZWxsIiAiLWwiCiAgICBsb2cgZmFpbGVkIGNvbXBsZXRlbHkKICAgIHByaW50ZiAiJXNcbiIgIkNvdWxkIG5vdCBleGVjdXRlIHRoZSBzaGVsbCAkbG9naW5fc2hlbGwgYXMgYSBsb2dpbiBzaGVsbCIgPiAvZGV2L3N0ZGVycgogICAgZXhlYyAiJGxvZ2luX3NoZWxsIgp9CgojIENvbW1hbmRzCiMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCgojIEZpZ3VyZSBvdXQgdGhlIHVzZXIncyBsb2dpbiBzaGVsbCBhbmQgcnVuIGl0Lgpjb25kdWN0b3JfY21kX2V4ZWNfbG9naW5fc2hlbGwoKSB7CiAgICBsb2cgY29uZHVjdG9yX2NtZF9leGVjX2xvZ2luX3NoZWxsCiAgICBleGVjX3NoZWxsPTEKfQoKcmVhbGx5X2V4ZWNfbG9naW5fc2hlbGwoKSB7CiAgICBleGVjX2xvZ2luX3NoZWxsICQoZ3Vlc3NfbG9naW5fc2hlbGwpCn0KCmNvbmR1Y3Rvcl9jbWRfZ2V0X3NoZWxsKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfZ2V0X3NoZWxsCiAgICBlY2hvICQoZ3Vlc3NfbG9naW5fc2hlbGwpCn0KCiMgU2V0IGFuIGVudmlyb25tZW50IHZhcmlhYmxlLgpjb25kdWN0b3JfY21kX3NldGVudigpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX3NldGVudgogICAgbG9jYWwgbmFtZT0kMQogICAgbG9jYWwgdmFsdWU9JDIKCiAgICBsb2cgc2V0ZW52ICR7bmFtZX09JHt2YWx1ZX0KICAgIGV4cG9ydCAke25hbWV9PSR7dmFsdWV9Cn0KCmNvbmR1Y3Rvcl9jbWRfcnVuKCkgewogICAgbG9nIGNvbmR1Y3Rvcl9jbWRfcnVuICQqCiAgICAkKgp9CgojIFVudGFyIGEgYmFzZTY0LWVuY29kZWQgZmlsZSBhdCBhIHNwZWNpZmllZCBsb2NhdGlvbi4KY29uZHVjdG9yX2NtZF93cml0ZSgpIHsKICAgIGxvZyBjb25kdWN0b3JfY21kX3dyaXRlCgogICAgbG9jYWwgYjY0ZGF0YT0kMQogICAgIyBVc2UgZXZhbCB0byBleHBhbmQgJEhPTUUKICAgIGxvY2FsIGRlc3RpbmF0aW9uPSQoZXZhbCBwcmludGYgJXMgIiQyIikKCiAgICBsb2cgd3JpdGluZyB0byAkZGVzdGluYXRpb24gYmFzZWQgb24gJDIKCiAgICAjIGV4dHJhY3QgdGhlIHRhciBmaWxlIGF0b21pY2FsbHksIGluIHRoZSBzZW5zZSB0aGF0IGFueSBmaWxlIGZyb20gdGhlCiAgICAjIHRhcmZpbGUgaXMgb25seSBwdXQgaW50byBwbGFjZSBhZnRlciBpdCBoYXMgYmVlbiBmdWxseSB3cml0dGVuIHRvIGRpc2sKICAgICMgc3VwcHJlc3MgU1RERVJSIGZvciB0YXIgYXMgdGFyIHByaW50cyB2YXJpb3VzIHdhcm5pbmdzIGlmIGZvciBpbnN0YW5jZSwgdGltZXN0YW1wcyBhcmUgaW4gdGhlIGZ1dHVyZQogICAgb2xkX3VtYXNrPSQodW1hc2spCiAgICB1bWFzayAwMDAKICAgIHByaW50ZiAiJXMiICR7YjY0ZGF0YX0gfCBiYXNlNjRfZGVjb2RlIHwgY29tbWFuZCB0YXIgInhwemYiICItIiAiLUMiICIkZGVzdGluYXRpb24iCiAgICBsb2NhbCByYz0kPwogICAgdW1hc2sgIiRvbGRfdW1hc2siCiAgICAoZXhpdCAkcmMpCn0KCmNvbmR1Y3Rvcl9jbWRfY2QoKSB7CiAgICBsb2NhbCBkaXI9JDEKCiAgICBsb2cgY2QgJGRpcgogICAgY2QgIiRkaXIiID4gL2Rldi9udWxsIDI+JjEKfQoKY29uZHVjdG9yX2NtZF9xdWl0KCkgewogICAgbG9nIHF1aXQKICAgIHF1aXQ9MQp9Cgpjb25kdWN0b3JfY21kX3BzKCkgewogICAgY29tbWFuZCBwcyAtZW8gcGlkLHBwaWQsY29tbWFuZCB8IGNhdAp9Cgpjb25kdWN0b3JfY21kX2dldHBpZCgpIHsKICAgIGVjaG8gJCQKfQoKIyBNYWluIExvb3AKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCmhhbmRsZV9jb21tYW5kKCkgewogICAgbG9jYWwgdW5wYXJzZWQ9JHsxfQoKICAgIGxvZyBoYW5kbGVfY29tbWFuZCAkdW5wYXJzZWQKCiAgICBsb2NhbCBjbWRfbmFtZT0kKGZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBjbWRfbmFtZSBpcyAkY21kX25hbWUKICAgIGxvY2FsIGFyZ3M9JChkcm9wX2ZpcnN0X3dvcmQgIiR7dW5wYXJzZWR9IikKICAgIGxvZyBhcmdzIGlzICRhcmdzCgogICAgbG9jYWwgYm91bmRhcnk9IiR7UkFORE9NfSR7UkFORE9NfSR7UkFORE9NfSR7UkFORE9NfSIKICAgIGVjaG8gYmVnaW4gJGJvdW5kYXJ5CiAgICBsb2cgaW52b2tlICRjbWRfbmFtZSB3aXRoIGFyZ3VtZW50cyAkYXJncwogICAgc2V0ICtlCiAgICBzZXQgK28gcGlwZWZhaWwKICAgIGlmIFtbICQodHlwZSAtdCBjb25kdWN0b3JfY21kXyR7Y21kX25hbWV9KSA9PSBmdW5jdGlvbiBdXTsgdGhlbgogICAgICAgIGNvbmR1Y3Rvcl9jbWRfJHtjbWRfbmFtZX0gJGFyZ3MKICAgIGVsc2UKICAgICAgICBlY2hvICJiYWQgY29tbWFuZCAke2NtZF9uYW1lfSIKICAgICAgICBmYWxzZQogICAgZmkKICAgIGVjaG8gZW5kICRib3VuZGFyeSAkPwogICAgaWYgW1sgJHF1aXQgPT0gMSBdXTsgdGhlbgogICAgICAgIGV4aXQgMAogICAgZmkKICAgIGlmIFtbICRleGVjX3NoZWxsID09IDEgXV07IHRoZW4KICAgICAgICBlY2hvIHVuaG9vawogICAgICAgIGNsZWFudXAKICAgICAgICByZWFsbHlfZXhlY19sb2dpbl9zaGVsbAogICAgZmkKICAgIHNldCAtZQogICAgc2V0IC1vIHBpcGVmYWlsCn0KCml0ZXJhdGUoKSB7CiAgICBsb2cgaXRlcmF0ZQoKICAgIHJlYWQgbGluZQogICAgbG9nIHJlYWQgbGluZSAiJGxpbmUiCiAgICBoYW5kbGVfY29tbWFuZCAiJGxpbmUiCn0KCmRyYWluX3N0ZGluKCkgewogIHN0dHkgLWVjaG8gLWljYW5vbiB0aW1lIDAgbWluIDAKICB3aGlsZSA6CiAgZG8KICAgICAga2V5PSIkKGVjaG8gLW4geDsgZGQgYnM9MSBjb3VudD0xIDI+IC9kZXYvbnVsbDsgZWNobyAtbiB4KSIKICAgICAgaWYgW1sgIiRrZXkiID09ICJ4eCIgXV07IHRoZW4KICAgICAgICAgIGJyZWFrCiAgICAgIGZpCiAgZG9uZQogIGNsZWFudXAKfQoKbWFpbigpIHsKICAgIGxvY2FsIHRva2VuPSQxCiAgICBsb2NhbCB1bmlxdWVpZD0kMgogICAgbG9jYWwgc3NoYXJncz0kKHByaW50ZiAlcyAiJDMiIHwgYmFzZTY0X2RlY29kZSkKCiAgICBsb2cgc3RhcnRpbmcgd2l0aCB0b2tlbiAkdG9rZW4KCiAgICB0cmFwICJjbGVhbnVwIiBFWElUCiAgICBkcmFpbl9zdGRpbgogICAgY29tbWFuZCBzdHR5ICItZWNobyIgPCAvZGV2L3R0eQogICAgcHJpbnRfZGNzICIkdG9rZW4iICIkdW5pcXVlaWQiICIkc3NoYXJncyIKCiAgICBsb2cgYmVnaW4gbWFpbmxvb3AKCiAgICB3aGlsZSB0cnVlOyBkbwogICAgICAgIGl0ZXJhdGUKICAgIGRvbmUKfQoK"

# Trying to escape this broke me.
eval_cmd=$(printf %s "J2V2YWwgIiQoZWNobyAiJDAiIHwgdHIgXFxcdlxcXGZcXFxyXFxcYiBcXFwwNDdcXFwxMzRcXFxuXFxcMDQxKSInIA==" | base64_decode)

sanitized="$(printf %s "$conductor" | base64_decode | tr "\!'\n\\" \\b\\v\\r\\f)"

SSH=/usr/bin/ssh
TOKEN="${ITERM_SESSION_ID#*:}"

if [ ! -d ~/.ssh ]; then
    mkdir ~/.ssh
    chmod 700 ~/.ssh
fi

print_osc
printf "1337;Env=report=all:"
command env | base64_encode
print_st

SSHARGS=$(printf %s "$*" | base64_encode)
UNIQUEID=${RANDOM}${RANDOM}

# Here we do /usr/bin/env sh rather than exec sh to avoid adding this command
# to the login shell's history.
$SSH \
-t \
-o \
ControlMaster=auto \
-o \
ControlPath=~/.ssh/control-%h-%p-%r \
-o \
ControlPersist=yes \
-o \
ServerAliveInterval=60 \
-o \
ServerAliveCountMax=5 \
-o \
TCPKeepAlive=no \
-- \
$1 \
/usr/bin/env \
sh \
-c \
"$eval_cmd" \
\'"$sanitized main $TOKEN ${UNIQUEID} $SSHARGS"\'

print_osc
printf "1337;EndSSH=%s" "${UNIQUEID}"
print_st

